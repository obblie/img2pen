<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Keepsake Studio - Create 3D Jewelry from Your Photos</title>
    <link rel="icon" type="image/x-icon" href="/IKSfav.ico">
    <!-- Tailwind CDN removed for production safety. Use built CSS or PostCSS/CLI if needed. -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap');
        
        :root {
            --bg-parchment: #F3EFE8;
            --bg-stone: #D8D1C7;
            --ink: #2B2B2B;
            --oxblood: #9C8F82;          /* primary accent (muted studio green) */
            --oxblood-strong: #7C6F64;   /* darker accent for hover/emphasis */
            --bronze: #B8874B;
            --highlight: #E8D9C8;        /* complementary bright accent */
        }
        
        html {
            background: var(--bg-parchment);
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-parchment);
            color: var(--ink);
            overflow-x: hidden;
            overflow-y: auto;
            width: 100vw;
        }
        
        /* Navigation Bar */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 100vw;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            z-index: 10000;
            transition: all 0.2s ease;
            padding: 14px 10px;
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: 12px;
            overflow: visible;
        }
        
        .navbar.shrink {
            padding: 10px 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.9);
        }
        
        .navbar-brand {
            font-family: 'Inter', 'JetBrains Mono', 'Courier New', monospace;
            font-weight: 700;
            font-size: 1.2em;
            color: #1f2937;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .navbar-brand img {
            height: 56px;
            width: auto;
        }
        
        .navbar-nav {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            list-style: none;
            margin: 0;
            padding: 0;
            align-items: center;
            justify-content: flex-end;
            width: 100%;
        }
        
        .navbar-nav a {
            font-family: 'Inter', 'JetBrains Mono', 'Courier New', monospace;
            font-weight: 600;
            font-size: 1.125em;
            color: #4b5563;
            text-decoration: none;
            padding: 6px 0;
            position: relative;
            transition: color 0.2s ease;
            white-space: nowrap;
        }
        
        .navbar-nav a:hover {
            color: #1f2937;
        }
        
        .navbar-nav a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 2px;
            background: #1f2937;
            transition: width 0.2s ease;
        }
        
        .navbar-nav a:hover::after {
            width: 100%;
        }
        
        /* Add padding to body to account for fixed navbar */
        body {
            padding-top: 70px;
        }
        
        @media (max-width: 768px) {
            .navbar {
                padding: 12px 16px;
            }
            
            .navbar.shrink {
                padding: 8px 16px;
            }
            
            .navbar-brand img {
                height: 49px;
            }
            
            .navbar-nav {
                gap: 12px;
            }
            
            .navbar-nav a {
                font-size: 1.1em;
            }
            
            body {
                padding-top: 64px;
            }
        }
        
        .hero-container {
            background: var(--bg-parchment);
            display: block;
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 40px;
            box-sizing: border-box;
        }
        
        .hero-title {
            font-weight: 800;
            font-size: 3.5em;
            margin-bottom: 20px;
            line-height: 1.1;
            color: var(--ink);
            max-width: 400px;
            word-wrap: break-word;
            text-align: center !important;
        }
        
        .hero-subtitle {
            font-size: 1.4em;
            margin-bottom: 30px;
            opacity: 0.9;
            line-height: 1.6;
            color: var(--ink);
            max-width: 350px;
            word-wrap: break-word;
            text-align: center !important;
        }
        
        .hero-upload-btn {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 18px auto 0;
            padding: 16px 28px;
            border-radius: 14px;
            border: 1px solid var(--oxblood);
            background: var(--oxblood);
            color: var(--bg-parchment);
            font-weight: 700;
            font-size: 1.05em;
            letter-spacing: 0.01em;
            cursor: pointer;
            box-shadow: 0 12px 26px rgba(0, 0, 0, 0.16);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            animation: none;
        }
        
        .hero-upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.2);
            background: var(--oxblood-strong);
            border-color: var(--oxblood-strong);
            color: var(--bg-parchment);
            animation: hero-upload-glow 1.2s ease-in-out infinite alternate, hero-upload-breathe 2.4s ease-in-out infinite;
        }
        
        .hero-upload-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 12px 26px rgba(0, 0, 0, 0.2);
            background: #eef1f7;
            animation: none;
        }

        @keyframes hero-upload-glow {
            0% {
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18), 0 0 0 0 rgba(255, 255, 255, 0.4);
            }
            100% {
                box-shadow: 0 18px 40px rgba(0, 0, 0, 0.25), 0 0 22px 6px rgba(255, 255, 255, 0.5);
            }
        }

        @keyframes hero-upload-breathe {
            0% {
                transform: scale(1);
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 22px 50px rgba(0, 0, 0, 0.28), 0 0 20px rgba(255, 255, 255, 0.28);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
            }
        }

        /* Hide debug export buttons but keep layout container */
        #debug-export-stl-btn,
        #export-pendant-only-btn {
            display: none !important;
        }

        /* Hide debug helper text and container */
        .debug-section,
        .debug-help-text {
            display: none !important;
            visibility: hidden !important;
        }

        /* Hide scrollbar handle for testimonials scroller */
        #testimonials-container {
            scrollbar-width: none;
        }
        #testimonials-container::-webkit-scrollbar {
            display: none;
        }
        
        .upload-container {
            background: var(--bg-parchment);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            min-height: 100vh;
            margin: 0;
            padding: 60px 24px;
            box-sizing: border-box;
            overflow: visible;
        }
        
        .scene-container {
            background: var(--bg-parchment);
            display: block;
            width: 100vw;
            height: auto;
            min-height: 100vh;
            margin: 0;
            padding: 40px;
            box-sizing: border-box;
            position: relative;
            overflow: visible;
        }


        #drop-zone {
            position: relative;
            width: 100%;
            min-height: 60vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            background: rgba(255, 255, 255, 0.9);
            color: black;
            border: 3px solid rgba(0, 0, 0, 0.8);
            border-radius: 16px;
            transition: opacity 0.3s;
        }
        #drop-zone.dragover {
            background: rgba(0, 0, 0, 0.1);
            border: 3px dashed rgba(0, 0, 0, 0.8);
        }
        #drop-zone.hidden {
            display: none;
        }
        #canvas-container {
            position: relative !important;
            width: 100% !important;
            height: 600px;
            margin: 0 !important;
            max-width: none !important;
            z-index: 1;
        }
        
        /* Removed conflicting #ui-menu CSS rules - now controlled by JavaScript */

        /* Lightbox effect for 3D scene */
        #canvas-container::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.15),
                0 8px 16px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(0, 0, 0, 0.05);
            z-index: -1;
            backdrop-filter: blur(10px);
        }

        #canvas {
            position: relative;
            z-index: 1;
            border-radius: 16px;
            overflow: hidden;
            width: 100% !important;
            height: 100% !important;
            display: block !important;
        }
        
        /* Ensure Three.js canvas fills container */
        canvas {
            width: 100% !important;
            height: 100% !important;
            display: block !important;
        }





        /* Desktop layout - vertical stacking */
        @media (min-width: 769px) {
            body {
                display: flex;
                flex-direction: column;
                min-height: 100vh;
                background: #f8f9fa;
            }
            
            #drop-zone {
                flex-shrink: 0;
                padding: 10px 20px;
                background: rgba(255, 255, 255, 0.9);
                border-bottom: 3px solid rgba(0, 0, 0, 0.8);
            }
            
            #reference-image-container {
                flex-shrink: 0;
                padding: 20px;
                text-align: center;
                background: rgba(255, 255, 255, 0.9);
                border-bottom: 3px solid rgba(0, 0, 0, 0.8);
            }
            
            #canvas-container {
                flex: 1;
                position: relative;
                min-height: 500px;
            }

            #canvas-container::before {
                top: 20px;
                left: 20px;
                right: 20px;
                bottom: 20px;
            }
        }

        /* Mobile layout - vertical stacking */
        @media (max-width: 768px) {
            body {
                display: flex;
                flex-direction: column;
                min-height: 100vh;
                background: #f8f9fa;
            }
            
            #drop-zone {
                flex-shrink: 0;
                padding: 20px;
                background: rgba(255, 255, 255, 0.9);
                border-bottom: 2px solid rgba(0, 0, 0, 0.8);
            }
            
            #reference-image-container {
                flex-shrink: 0;
                padding: 15px;
                text-align: center;
                background: rgba(255, 255, 255, 0.9);
                border-bottom: 2px solid rgba(0, 0, 0, 0.8);
                position: relative !important;
                top: auto !important;
                left: auto !important;
                max-width: 100% !important;
                width: 100% !important;
            }

            #reference-image {
                cursor: pointer;
                width: 150px;
                height: 150px;
            }
            
            #canvas-container {
                flex: 1;
                position: relative;
                min-height: 400px;
            }
        }

        /* Reference Image Container - Base Styles */
        #reference-image-container {
            position: relative;
            padding: 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 3px solid rgba(0, 0, 0, 0.8);
            display: block;
        }

        #reference-image-container:hover {
            transform: scale(1.05);
            opacity: 1;
        }

        #reference-image-container.collapsed {
            opacity: 0.7;
            max-width: 60px;
            overflow: hidden;
        }

        #reference-image-container.collapsed #reference-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
        }

        #reference-image-container.collapsed #reference-label {
            display: none;
        }

        #reference-image {
            width: 180px;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            display: block;
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #reference-image:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        #reference-label {
            color: #333;
            font-size: 12px;
            text-align: center;
            margin: 0;
            font-weight: 600;
        }

        #reference-toggle {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            color: #333;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        #reference-toggle:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Make canvas fill available space */
        #canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Hide the floating UI menu - now using integrated version */
        #ui-menu {
            display: none !important;
        }

            /* Adjust mobile menu toggle position */
            #mobile-menu-toggle {
                top: 15px;
                right: 15px;
                width: 50px;
                height: 50px;
                font-size: 20px;
                background: rgba(255, 255, 255, 0.9);
                border: 2px solid rgba(0, 0, 0, 0.1);
                color: #333;
            }

            /* Adjust replace image button position */
            #replace-image-button {
                top: 15px;
                left: 15px;
            }

            #replace-file {
                background: rgba(255, 255, 255, 0.9) !important;
                border: 2px solid rgba(0, 0, 0, 0.1) !important;
                color: #333 !important;
            }

        /* Extra small mobile devices */
        @media (max-width: 480px) {
            #reference-image {
                width: 150px;
                height: 150px;
            }

            #reference-label {
                font-size: 14px;
            }

            #reference-image-container {
                padding: 15px;
            }
            
            /* Ensure mobile menu toggle is visible on small screens */
            #mobile-menu-toggle {
                width: 50px;
                height: 50px;
                font-size: 20px;
                top: 10px;
                right: 10px;
            }
            
            /* Optimize text for small screens */
            .hero-container h1 {
                font-size: 1.8em;
            }
            
            .hero-container p {
                font-size: 0.9em;
            }
        }

        /* Mobile Menu Toggle Button */
        #mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            color: #000000;
            font-size: 24px;
            cursor: pointer;
            z-index: 1001;
            transition: transform 0.2s ease, background 0.2s ease;
            backdrop-filter: blur(10px);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            font-weight: bold;
        }



        #mobile-menu-toggle:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 1);
        }

        #mobile-menu-toggle:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            /* Hide mobile menu toggle on mobile - we don't need it */
            #mobile-menu-toggle {
                display: none !important;
            }
            
            /* Optimize replace image button for mobile */
            #replace-image-button {
                top: 10px !important;
                left: 10px !important;
            }
            
            #replace-file {
                padding: 8px 12px !important;
                font-size: 14px !important;
                min-height: 44px !important;
            }
            
            /* Ensure proper scrolling on mobile */
            body {
                overflow-x: hidden;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                height: auto;
            }
            
            html {
                height: auto;
                overflow-x: hidden;
                overflow-y: auto;
            }
            
            /* Mobile container scrolling */
            .hero-container,
            .upload-container,
            .scene-container {
                overflow-y: visible;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Mobile-optimized cropper modal */
            #cropper-modal > div {
                flex-direction: column !important;
                max-width: 95vw !important;
                max-height: 95vh !important;
                padding: 16px !important;
                gap: 12px !important;
                overflow-y: auto !important;
            }
            
            #cropper-image {
                max-width: 90vw !important;
                max-height: 40vh !important;
                flex-shrink: 0 !important;
            }
            
            /* Ensure action buttons are always accessible */
            #cropper-modal .action-buttons {
                position: sticky !important;
                bottom: 0 !important;
                background: #222 !important;
                padding: 16px 0 !important;
                margin: 0 -16px !important;
                border-top: 1px solid rgba(255,255,255,0.1) !important;
                z-index: 10 !important;
            }
            
            #cropper-toolbar {
                flex-wrap: wrap !important;
                justify-content: center !important;
                gap: 8px !important;
                margin-top: 12px !important;
            }
            
            #cropper-toolbar button {
                min-width: 44px !important;
                min-height: 44px !important;
                font-size: 18px !important;
                padding: 8px !important;
                border-radius: 8px !important;
                background: rgba(255, 255, 255, 0.1) !important;
                border: 1px solid rgba(255, 255, 255, 0.3) !important;
                color: white !important;
            }
            
            #cropper-toolbar select {
                min-height: 44px !important;
                font-size: 16px !important;
                padding: 8px 12px !important;
                background: rgba(255, 255, 255, 0.1) !important;
                border: 1px solid rgba(255, 255, 255, 0.3) !important;
                color: white !important;
                border-radius: 8px !important;
            }
            
            #cropper-pixel-controls {
                flex-wrap: wrap !important;
                justify-content: center !important;
                gap: 6px !important;
                margin: 8px 0 !important;
            }
            
            #cropper-pixel-controls label {
                font-size: 14px !important;
            }
            
            #cropper-pixel-controls input {
                width: 50px !important;
                padding: 4px !important;
                font-size: 14px !important;
            }
            
            #cropper-preview-container {
                min-width: auto !important;
                width: 100% !important;
                max-width: 280px !important;
            }
            
            #cropper-confirm,
            #cropper-cancel {
                padding: 12px 20px !important;
                font-size: 16px !important;
                min-height: 44px !important;
                min-width: 120px !important;
                touch-action: manipulation !important;
                border-radius: 8px !important;
                border: none !important;
                cursor: pointer !important;
            }
            
            #cropper-confirm {
                background: #4CAF50 !important;
                color: white !important;
            }
            
            #cropper-cancel {
                background: #666 !important;
                color: white !important;
            }
            
            /* Force buttons to always be visible */
            @media (max-height: 600px) {
                #cropper-image {
                    max-height: 30vh !important;
                }
                
                #cropper-toolbar {
                    margin-top: 8px !important;
                }
                
                #cropper-pixel-controls {
                    display: none !important; /* Hide detailed controls on very small screens */
                }
            }
            
            /* Ruler overlay mobile responsive styles */
            @media (max-width: 768px) {
                #horizontal-ruler {
                    width: 300px !important;
                    font-size: 9px !important;
                }
                
                #vertical-ruler {
                    height: 300px !important;
                    font-size: 9px !important;
                }
                
                #reference-circle {
                    border-width: 1px !important;
                }
                
                #reference-circle > div {
                    font-size: 11px !important;
                    top: -20px !important;
                }
            }
            
            @media (max-width: 480px) {
                #horizontal-ruler {
                    width: 250px !important;
                    height: 15px !important;
                }
                
                #vertical-ruler {
                    height: 250px !important;
                    width: 15px !important;
                }
                
                #ruler-overlay {
                    font-size: 8px !important;
                }
            }
            
            /* Enhanced mobile cropper controls */
            #cropper-image {
                touch-action: none !important;
                user-select: none !important;
                -webkit-user-select: none !important;
            }
            
            /* Make crop selection more visible on mobile */
            .cropper-crop-box {
                border: 3px solid #39f !important;
                box-shadow: 0 0 0 1px rgba(255,255,255,0.5) !important;
            }
            
            .cropper-point {
                width: 20px !important;
                height: 20px !important;
                background: #39f !important;
                border: 2px solid white !important;
                border-radius: 50% !important;
            }
            
            .cropper-line {
                background: rgba(57, 255, 255, 0.3) !important;
            }
            
            /* Larger touch targets for crop handles */
            .cropper-point.point-e,
            .cropper-point.point-w,
            .cropper-point.point-n,
            .cropper-point.point-s,
            .cropper-point.point-ne,
            .cropper-point.point-nw,
            .cropper-point.point-se,
            .cropper-point.point-sw {
                width: 24px !important;
                height: 24px !important;
            }
        }
        .instructions {
            text-align: center;
            padding: 20px;
        }
        .instructions p {
            margin: 10px 0;
        }

        /* UI Menu Styles */
        #ui-menu {
            position: fixed !important;
            top: 500px !important;
            left: calc(50% - 600px + 20px) !important;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 15px;
            border-radius: 12px;
            width: 280px;
            height: 60vh;
            overflow-y: auto;
            z-index: 1001 !important;
            transition: transform 0.3s ease, width 0.3s ease, top 0.3s ease, left 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border: 3px solid rgba(0, 0, 0, 0.8);
        }

        /* Mobile Responsive Styles - Shopify-style Layout */
        @media (max-width: 768px) {
            /* CRITICAL: Override ALL conflicting mobile rules */
            body {
                display: block !important;
                flex-direction: unset !important;
                min-height: auto !important;
                background: unset !important;
                overflow-x: hidden !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
                height: auto !important;
            }
            
            html {
                height: auto !important;
                overflow-x: hidden !important;
                overflow-y: auto !important;
            }
            
            /* Override ALL container layouts */
            .hero-container,
            .upload-container,
            .scene-container {
                padding: 0 !important;
                height: auto !important;
                min-height: auto !important;
                margin: 0 !important;
                width: 100% !important;
                display: block !important;
                overflow-y: visible !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            /* Override ALL drop-zone rules */
            #drop-zone {
                flex-shrink: unset !important;
                padding: unset !important;
                background: unset !important;
                border-bottom: unset !important;
                min-height: unset !important;
            }
            
            /* Override ALL reference-image-container rules */
            #reference-image-container {
                flex-shrink: unset !important;
                padding: unset !important;
                text-align: unset !important;
                background: unset !important;
                border-bottom: unset !important;
                position: unset !important;
                top: unset !important;
                left: unset !important;
                max-width: unset !important;
                width: unset !important;
            }
            
            /* Override ALL ui-menu rules */
            #ui-menu {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                width: unset !important;
                height: unset !important;
                max-height: unset !important;
                padding: unset !important;
                right: unset !important;
            }
            
            /* Hide the entire ui-controls-section */
            .ui-controls-section {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
            }
            
            /* Override ALL control-group rules */
            .control-group {
                margin-bottom: unset !important;
            }
            
            .control-group label {
                font-size: unset !important;
                margin-bottom: unset !important;
                display: unset !important;
            }
            
            .control-group select,
            .control-group input[type="range"],
            .control-group input[type="number"] {
                font-size: unset !important;
                min-height: unset !important;
                background: unset !important;
                color: unset !important;
                border: unset !important;
                font-weight: unset !important;
                width: unset !important;
                box-sizing: unset !important;
                padding: unset !important;
            }
            
            /* Override ALL toggle-button rules */
            .toggle-button {
                font-size: unset !important;
                padding: unset !important;
                min-width: unset !important;
                min-height: unset !important;
                background: unset !important;
                border: unset !important;
                color: unset !important;
                font-weight: unset !important;
            }
            
            /* Override ALL menu-section rules */
            .menu-section {
                margin-bottom: unset !important;
                padding-bottom: unset !important;
                border-bottom: unset !important;
            }
            
            /* Override ALL ruler-overlay rules */
            #ruler-overlay {
                transform: unset !important;
            }
            
            /* Override ALL cta-button rules */
            .cta-button {
                padding: unset !important;
                font-size: unset !important;
                min-height: unset !important;
                width: unset !important;
                max-width: unset !important;
            }
            
            /* Disable canvas-container lightbox effect on mobile */
            #canvas-container::before {
                display: none !important;
                content: none !important;
                background: none !important;
                backdrop-filter: none !important;
            }
            
            /* Force mobile layout at exactly 768px and below */
            .mobile-shopify-layout {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            .desktop-layout {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
            }
            /* Force mobile layout at exactly 768px and below */
            .mobile-shopify-layout {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            .desktop-layout {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
            }
            /* Fix body and html scrolling */
            body, html {
                height: auto !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
            }
            
            /* Mobile Container Layout - Shopify-style */
            .hero-container {
                padding: 0 !important;
                height: auto !important;
                min-height: auto !important;
                margin-bottom: 0 !important;
                width: 100% !important;
                display: block !important;
            }
            
            .upload-container {
                padding: 0 !important;
                height: auto !important;
                min-height: auto !important;
                margin-bottom: 0 !important;
                width: 100% !important;
                display: block !important;
            }
            
            .scene-container {
                padding: 0 !important;
                height: auto !important;
                min-height: auto !important;
                margin: 0 !important;
                width: 100% !important;
                display: block !important;
            }
            
            /* Mobile spacing improvements */
            .hero-container,
            .upload-container,
            .scene-container {
                box-sizing: border-box;
            }
            
            /* Shopify-style Mobile Layout */
            .mobile-shopify-layout {
                display: flex !important;
                flex-direction: column !important;
                width: 100% !important;
                height: 100vh !important;
                overflow-y: auto !important;
            }
            
            /* Product Carousel Section */
            .product-carousel-section {
                flex: 1 !important;
                min-height: 60vh !important;
                height: 60vh !important;
                background: transparent !important;
                position: relative !important;
                overflow: hidden !important;
            }
            
            /* Main Product Viewer */
            .main-product-viewer {
                width: 100% !important;
                height: 100% !important;
                position: relative !important;
                background: transparent !important;
                overflow: hidden !important;
            }
            
            /* Mobile Canvas Container */
            #mobile-canvas-container {
                width: 100% !important;
                height: 100% !important;
                position: relative !important;
                background: transparent !important;
                overflow: hidden !important;
                min-height: 400px !important;
            }
            
            #mobile-canvas-container canvas {
                width: 100% !important;
                height: 100% !important;
                display: block !important;
            }
            
            /* Carousel Thumbnails */
            .carousel-thumbnails {
                display: flex !important;
                gap: 8px !important;
                padding: 12px !important;
                background: #ffffff !important;
                border-top: 1px solid #e2e8f0 !important;
                overflow-x: auto !important;
            }
            
            .carousel-thumbnail {
                flex-shrink: 0 !important;
                width: 60px !important;
                height: 60px !important;
                border: 2px solid #e2e8f0 !important;
                border-radius: 8px !important;
                background: #f8f9fa !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: border-color 0.2s ease !important;
            }
            
            .carousel-thumbnail.active {
                border-color: #1d4ed8 !important;
                background: #1d4ed8 !important;
                color: white !important;
            }
            
            /* Product Details Section */
            .product-details-section {
                background: #ffffff !important;
                padding: 20px !important;
                border-top: 1px solid #e2e8f0 !important;
            }
            
            /* Product Title and Price */
            .product-title {
                font-size: 1.5em !important;
                font-weight: 700 !important;
                color: #2d3748 !important;
                margin-bottom: 8px !important;
            }
            
            .product-price {
                font-size: 1.2em !important;
                font-weight: 600 !important;
                color: #1d4ed8 !important;
                margin-bottom: 16px !important;
            }
            
            .product-subtitle {
                font-size: 0.9em !important;
                color: #718096 !important;
                margin-bottom: 20px !important;
            }
            
            /* Customization Options */
            .customization-options {
                display: flex !important;
                flex-direction: column !important;
                gap: 16px !important;
            }
            
            .option-group {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
            }
            
            .option-label {
                font-size: 0.9em !important;
                font-weight: 600 !important;
                color: #2d3748 !important;
            }
            
            .option-buttons {
                display: flex !important;
                gap: 8px !important;
                flex-wrap: wrap !important;
            }
            
            .option-button {
                padding: 8px 16px !important;
                border: 2px solid #e2e8f0 !important;
                border-radius: 6px !important;
                background: #ffffff !important;
                color: #2d3748 !important;
                font-size: 0.9em !important;
                font-weight: 500 !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
                min-height: 44px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .option-button.active {
                border-color: #1d4ed8 !important;
                background: #1d4ed8 !important;
                color: #ffffff !important;
            }
            
            .option-select {
                padding: 12px !important;
                border: 2px solid #e2e8f0 !important;
                border-radius: 6px !important;
                background: #ffffff !important;
                color: #2d3748 !important;
                font-size: 0.9em !important;
                min-height: 44px !important;
            }
            
            /* Add Photo Button */
            .add-photo-section {
                margin-top: 0 !important;
                padding: 8px !important;
                background: var(--bg-stone) !important;
                color: var(--ink) !important;
                border-radius: 10px !important;
                border: 1px solid rgba(43, 43, 43, 0.12) !important;
                text-align: center !important;
                box-shadow: 0 8px 16px rgba(0,0,0,0.12) !important;
            }
            
            .add-photo-button {
                width: 100% !important;
                height: 44px !important;
                padding: 10px 12px !important;
                background: var(--oxblood) !important;
                color: var(--bg-parchment) !important;
                border: 1px solid var(--oxblood) !important;
                border-radius: 10px !important;
                font-size: 0.9em !important;
                font-weight: 600 !important;
                cursor: pointer !important;
                transition: all 0.25s ease !important;
                min-height: 40px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 8px !important;
                backdrop-filter: blur(6px) !important;
            }
            
            .add-photo-button:hover {
                background: var(--oxblood-strong) !important;
                transform: translateY(-2px) !important;
                box-shadow: 0 8px 22px rgba(0, 0, 0, 0.16) !important;
            }
            
            .photo-help-text {
                color: var(--ink) !important;
                margin: 8px 0 0 0 !important;
                font-size: 0.8em !important;
                line-height: 1.4 !important;
            }
            
            .action-buttons-container {
                flex-direction: row !important;
                gap: 8px !important;
            }
            
            .action-buttons-container .add-photo-section,
            .action-buttons-container .imagine-section {
                width: 50% !important;
                min-width: 0 !important;
            }
            .imagine-section {
                background: var(--bg-stone) !important;
                color: var(--ink) !important;
                border: 1px solid rgba(43,43,43,0.12) !important;
            }
            .imagine-button {
                background: var(--oxblood) !important;
                color: var(--bg-parchment) !important;
                border: 1px solid var(--oxblood) !important;
            }
            .imagine-button:hover {
            background: var(--oxblood-strong) !important;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.16) !important;
            }
            
            /* Mobile Hero Section - Fix grid layout */
            .hero-container > div {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 30px !important;
                padding: 20px !important;
            }
            
            /* Show mobile layout, hide desktop layout */
            .mobile-shopify-layout {
                display: flex !important;
            }
            
            .desktop-layout {
                display: none !important;
            }
            
            /* Hide desktop controls on mobile */
            .ui-menu-panel {
                display: none !important;
            }
            
            #dat-gui-container {
                display: none !important;
            }
            
            /* Override conflicting canvas-container rules */
            #canvas-container {
                flex: none !important;
                position: relative !important;
                min-height: auto !important;
            }
            
            /* Override conflicting body rules */
            body {
                display: block !important;
                flex-direction: unset !important;
                min-height: auto !important;
                background: unset !important;
            }
            
            /* Override conflicting drop-zone rules */
            #drop-zone {
                flex-shrink: unset !important;
                padding: unset !important;
                background: unset !important;
                border-bottom: unset !important;
            }
            
            /* Override conflicting reference-image-container rules */
            #reference-image-container {
                flex-shrink: unset !important;
                padding: unset !important;
                text-align: unset !important;
                background: unset !important;
                border-bottom: unset !important;
                position: unset !important;
                top: unset !important;
                left: unset !important;
                max-width: unset !important;
                width: unset !important;
            }
            
            /* Mobile Hero Section - Photo first, then text */
            .hero-container > div > div:first-child {
                order: 1 !important; /* logo/text first on mobile */
            }
            
            .hero-container > div > div:last-child {
                order: 2 !important; /* photos after text on mobile */
                justify-content: center !important;
                align-items: center !important;
            }
            
            .hero-container h1 {
                font-size: 2em !important;
                font-weight: normal !important;
                line-height: 1.2 !important;
                margin-bottom: 20px !important;
                text-align: center !important;
                white-space: normal !important;
                word-wrap: normal !important;
                word-break: keep-all !important;
                overflow-wrap: normal !important;
            }
            
            .hero-container p {
                font-size: 1.1em;
                line-height: 1.6;
                margin-bottom: 30px;
                text-align: center !important;
            }
            
            /* Mobile Upload Section */
            #drop-zone {
                min-height: auto !important;
                height: auto !important;
                padding: 30px 20px !important;
            }
            
            /* Mobile Upload/Imagine containers - stack vertically */
            #upload-options-grid {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 20px !important;
                margin-bottom: 20px !important;
            }
            
            #drop-zone h2 {
                font-size: 1.8em;
                margin-bottom: 15px;
            }
            
            #drop-zone p {
                font-size: 1em;
                margin-bottom: 20px;
            }
            
            /* Mobile 3D Scene - Stacked layout */
            #canvas-container {
                height: 400px !important;
                min-height: 400px !important;
                width: 100% !important;
                max-height: none !important;
                border: 2px solid #ddd !important;
                border-radius: 12px !important;
                margin-bottom: 20px !important;
            }
            
            /* Add spacing between containers to prevent overlap */
            .hero-container {
                margin-bottom: 20px !important;
            }
            
            .upload-container {
                margin-bottom: 20px !important;
            }
            
            /* Fix main site container for mobile */
            #main-site-container {
                min-height: auto !important;
                height: auto !important;
                overflow-x: hidden !important;
                overflow-y: visible !important;
            }
            
            /* Mobile scene container - stacked instead of side-by-side */
            .scene-container > div {
                flex-direction: column !important;
                height: auto !important;
                gap: 20px !important;
                padding: 20px !important;
            }
            
            /* Mobile scene container title */
            .scene-container h2 {
                font-size: 1.8em !important;
                margin-bottom: 10px !important;
            }
            
            .scene-container p {
                font-size: 1em !important;
                margin-bottom: 20px !important;
            }
            
                    /* Mobile Control Panel - Compact layout */
        #ui-menu {
            position: relative !important;
            top: auto !important;
            right: auto !important;
            left: auto !important;
            width: 45% !important;
            height: auto !important;
            max-height: 200px !important;
            border-radius: 8px !important;
            z-index: 1001 !important;
            overflow-y: auto !important;
            padding: 6px !important;
            background: rgba(255,255,255,0.95) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3) !important;
            margin: 0 auto 10px auto !important;
            font-size: 0.7em !important;
        }
            
            /* Mobile handle removed - not using drawer approach */

            /* Mobile Menu Sections - Compact */
            .menu-section {
                margin-bottom: 2px !important;
            }

            .menu-header {
                padding: 1px 0 !important;
                font-size: 0.6em !important;
            }
            
            .menu-header h3 {
                font-size: 0.65em !important;
                margin: 0 !important;
            }

            .control-group {
                margin-bottom: 2px !important;
                font-size: 0.6em !important;
            }
            
            .control-group label {
                font-size: 0.6em !important;
                margin-bottom: 1px !important;
            }
            
            .control-group input,
            .control-group select {
                font-size: 0.6em !important;
                padding: 1px !important;
            }
            
            /* Mobile Ruler Overlay */
            #ruler-overlay {
                transform: scale(0.7) !important;
            }
            
            /* Mobile sample image */
            .hero-container img {
                width: 300px !important;
                height: 300px !important;
                max-width: 45vw !important;
                max-height: 45vw !important;
                display: block !important;
                margin: 0 auto !important;
                object-fit: cover !important;
            }
            
            /* Mobile hero badges - keep horizontal but adjust spacing */
            .hero-container div[style*="display: flex; gap: 20px; flex-wrap: wrap;"] {
                display: flex !important;
                flex-direction: row !important;
                gap: 10px !important;
                justify-content: center !important;
                flex-wrap: nowrap !important;
            }
            
            /* Mobile hero badge styling - make smaller */
            .hero-container div[style*="display: flex; gap: 20px; flex-wrap: wrap;"] > div {
                padding: 10px 15px !important;
                font-size: 0.9em !important;
                white-space: nowrap !important;
            }
            
            /* Mobile Buttons */
            .cta-button {
                padding: 15px 30px;
                font-size: 1.1em;
                min-height: 50px;
            }
            
            /* Mobile Text */
            h1, h2, h3 {
                word-wrap: break-word;
                hyphens: auto;
            }
        }

        @media (max-width: 480px) {
            /* Small Mobile Container Layout */
            .hero-container {
                padding: 60px 20px 40px 20px;
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
                text-align: center !important;
                min-height: 100vh;
                box-sizing: border-box;
            }
            
            /* Force hero text centering with maximum specificity */
            .hero-container h1,
            .hero-container .hero-title,
            .hero-container p,
            .hero-container .hero-subtitle {
                text-align: center !important;
                color: var(--ink) !important;
            }
            
            /* Mobile hero container improvements */
            .hero-container > div {
                width: 100% !important;
                max-width: 100% !important;
                padding: 20px 0 !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 40px !important;
            }
            
            .hero-container > div > div {
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 15px !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            /* Stack images + button vertically; keep images row inside */
            .hero-container > div > div:last-child {
                display: flex !important;
                flex-direction: column !important;
                flex-wrap: nowrap !important;
                gap: 12px !important;
                align-items: center !important;
                justify-content: center !important;
            }
            .hero-image-row {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                gap: 8px !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .hero-upload-btn {
                max-width: 260px;
                padding: 14px 18px;
                font-size: 1em;
            }
            
            .upload-container {
                padding: 15px;
            }
            
            .scene-container {
                padding: 15px;
            }
            
            /* Small Mobile Hero Section */
            .hero-title {
                font-size: 2.2em !important;
                margin-bottom: 20px !important;
                max-width: 100% !important;
                text-align: center !important;
                line-height: 1.1 !important;
                font-weight: 800 !important;
                color: white !important;
            }
            
            .hero-subtitle {
                font-size: 1.1em !important;
                margin-bottom: 30px !important;
                max-width: 100% !important;
                text-align: center !important;
                line-height: 1.5 !important;
                color: white !important;
                opacity: 0.9 !important;
            }
            
            /* Mobile feature badges */
            .hero-container .hero-subtitle + div {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
                align-items: center !important;
                justify-content: center !important;
                margin-top: -45px !important; /* Move badges back to original position */
            }
            
            .hero-container .hero-subtitle + div > div {
                width: auto !important;
                min-width: 200px !important;
                padding: 12px 20px !important;
                font-size: 0.9em !important;
            }
            
            /* Mobile sample image */
            .hero-container img {
                width: 250px !important;
                height: 250px !important;
                margin-top: 40px !important;
                margin-bottom: 20px !important;
            }
            
            /* Small Mobile Upload Section */
            #drop-zone {
                min-height: 45vh;
                padding: 20px 15px;
            }
            
            #drop-zone h2 {
                font-size: 1.6em;
                margin-bottom: 12px;
            }
            
            /* Small Mobile Control Panel */
            #ui-menu {
                width: 40% !important;
                height: auto !important;
                max-height: 150px !important;
                padding: 4px !important;
                right: auto !important;
            }
            
            /* Touch-friendly controls - Compact */
            .control-group {
                margin-bottom: 4px;
            }
            
            .control-group label {
                font-size: 12px;
                margin-bottom: 2px;
                display: block;
            }
            
            .control-group select,
            .control-group input[type="range"],
            .control-group input[type="number"] {
                font-size: 12px; /* Prevents zoom on iOS */
                min-height: 24px; /* Smaller touch-friendly size */
                background: rgba(255, 255, 255, 0.9);
                color: #000000;
                border: 2px solid rgba(0, 0, 0, 0.8);
                font-weight: 500;
                width: 100%;
                box-sizing: border-box;
            }
            
            .toggle-button {
                font-size: 14px;
                padding: 2px;
                min-width: 24px;
                min-height: 24px;
                background: rgba(255, 255, 255, 0.9);
                border: 2px solid rgba(0, 0, 0, 0.8);
                color: #000000;
                font-weight: bold;
            }
            
            /* Small Mobile Ruler Overlay */
            #ruler-overlay {
                transform: scale(0.6) !important;
            }
            
            /* Small Mobile Buttons */
            .cta-button {
                padding: 12px 25px;
                font-size: 1em;
                min-height: 44px;
                width: 100%;
                max-width: 300px;
            }
        }
        
        /* Custom scrollbar for the menu */
        #ui-menu::-webkit-scrollbar {
            width: 8px;
        }
        
        #ui-menu::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        #ui-menu::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        #ui-menu::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        .menu-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.8);
        }
        
        /* Mobile-specific menu section styling */
        @media (max-width: 768px) {
            .menu-section {
                margin-bottom: 3px;
                padding-bottom: 3px;
                border-bottom: 1px solid rgba(0, 0, 0, 0.6);
            }
        }
        .menu-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            color: #000000;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        .menu-content {
            margin-top: 10px;
            display: none;
        }
        .menu-content.active {
            display: block;
        }
        .control-group {
            margin-bottom: 10px;
        }
        
        /* Mobile-specific control group styling */
        @media (max-width: 768px) {
            .control-group {
                margin-bottom: 2px;
            }
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #000000;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        .control-group input[type="range"] {
            width: 100%;
            border: 2px solid rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        /* Mobile-specific input styling */
        @media (max-width: 768px) {
            .control-group input[type="range"] {
                height: 16px;
            }
        }
        .control-group select {
            width: 100%;
            padding: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #000000;
            border: 2px solid rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            font-weight: 500;
        }
        
        /* Mobile-specific select styling */
        @media (max-width: 768px) {
            .control-group select {
                padding: 2px;
                font-size: 11px;
            }
        }
        .control-group input[type="number"] {
            width: 60px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #000000;
            border: 2px solid rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            font-weight: 500;
        }
        
        /* Mobile-specific number input styling */
        @media (max-width: 768px) {
            .control-group input[type="number"] {
                width: 40px;
                padding: 2px;
                font-size: 11px;
            }
        }
        .toggle-button {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(0, 0, 0, 0.8);
            color: #000000;
            font-size: 20px;
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        /* Mobile-specific toggle button styling */
        @media (max-width: 768px) {
            .toggle-button {
                font-size: 12px;
                padding: 1px 4px;
            }
        }
        
        /* Ruler toggle button styles */
        #ruler-toggle {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 2px solid rgba(0, 0, 0, 0.8) !important;
            padding: 8px 16px !important;
            border-radius: 4px !important;
            font-size: 14px !important;
            transition: background-color 0.2s !important;
            color: #000000 !important;
            font-weight: 600 !important;
        }
        
#ruler-toggle[data-active="true"] {
    background: #1d4ed8 !important;
    color: white !important;
}

        /* Additional UI styles */
        .control-group input[type="color"] {
            width: 100%;
            height: 30px;
            padding: 2px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(0, 0, 0, 0.8);
            border-radius: 4px;
        }
        .control-group .position-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .control-group .position-controls input {
            width: 100%;
        }

        /* Text Box Styles */
        .text-box-item {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(0, 0, 0, 0.8);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
        }
        
        /* Mobile-specific text box styling */
        @media (max-width: 768px) {
            .text-box-item {
                padding: 4px;
                margin-bottom: 4px;
            }
        }
        .text-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        /* Mobile-specific text box header styling */
        @media (max-width: 768px) {
            .text-box-header {
                margin-bottom: 3px;
            }
        }
        .text-box-title {
            font-weight: bold;
            font-size: 0.9em;
            color: #000000;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        /* Mobile-specific text box title styling */
        @media (max-width: 768px) {
            .text-box-title {
                font-size: 0.7em;
            }
        }
        .text-box-controls {
            display: none;
        }
        .text-box-controls.active {
            display: block;
        }
        .text-box-delete {
            background: #f44336;
            color: white;
            border: 2px solid rgba(0, 0, 0, 0.8);
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
        }
        .text-box-toggle {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(0, 0, 0, 0.8);
            color: #000000;
            font-size: 16px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .control-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        /* Mobile-specific control row styling */
        @media (max-width: 768px) {
            .control-row {
                gap: 3px;
                margin-bottom: 2px;
            }
        }
        .control-row.full-width {
            grid-template-columns: 1fr;
        }
        .control-row label {
            font-size: 0.85em;
            margin-bottom: 3px;
            color: #000000;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        /* Mobile-specific control row label styling */
        @media (max-width: 768px) {
            .control-row label {
                font-size: 0.65em;
                margin-bottom: 1px;
            }
        }
        .control-row input, .control-row select, .control-row textarea {
            font-size: 0.85em;
            padding: 4px;
            background: rgba(255, 255, 255, 0.9);
            color: #000000;
            border: 2px solid rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            font-weight: 500;
        }
        
        /* Mobile-specific control row input styling */
        @media (max-width: 768px) {
            .control-row input, .control-row select, .control-row textarea {
                font-size: 0.65em;
                padding: 1px;
            }
        }
        .char-counter {
            text-align: right;
            font-size: 0.8em;
            color: #000000;
            margin-top: 2px;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        /* Mobile-specific scene title container styling */
        @media (max-width: 768px) {
            .scene-title-container {
                padding: 6px 12px !important;
                border-radius: 8px !important;
                top: 10px !important;
                left: 10px !important;
            }
            
            .scene-title-container h2 {
                font-size: 1.2em !important;
                margin: 0 !important;
            }
            
            .scene-title-container p {
                font-size: 0.7em !important;
                margin: 2px 0 0 0 !important;
            }
            
            /* Override inline styles for mobile */
            .ui-menu-panel {
                width: 30% !important;
                min-width: 200px !important;
                position: relative !important;
                top: auto !important;
                right: auto !important;
                left: auto !important;
                height: auto !important;
                max-height: 200px !important;
                padding: 4px !important;
                border-radius: 8px !important;
                margin: 0 auto 10px auto !important;
                font-size: 0.7em !important;
            }
        }
        
        @media (max-width: 480px) {
            .scene-title-container {
                padding: 4px 8px !important;
                border-radius: 6px !important;
                top: 8px !important;
                left: 8px !important;
            }
            
            .scene-title-container h2 {
                font-size: 1em !important;
            }
            
            .scene-title-container p {
                font-size: 0.6em !important;
                margin: 1px 0 0 0 !important;
            }
            
            /* Override inline styles for small mobile */
            .ui-menu-panel {
                width: 25% !important;
                min-width: 150px !important;
                max-height: 150px !important;
                padding: 2px !important;
            }
            
            /* Ensure mobile layout is shown on small screens */
            .mobile-shopify-layout {
                display: flex !important;
            }
            
            .desktop-layout {
                display: none !important;
            }
            
            /* Hide desktop controls on small mobile */
            .ui-menu-panel {
                display: none !important;
            }
            
            #dat-gui-container {
                display: none !important;
            }
            
            /* Override conflicting rules for small mobile */
            #canvas-container {
                flex: none !important;
                position: relative !important;
                min-height: auto !important;
            }
            
            body {
                display: block !important;
                flex-direction: unset !important;
                min-height: auto !important;
                background: unset !important;
            }
            
            #drop-zone {
                flex-shrink: unset !important;
                padding: unset !important;
                background: unset !important;
                border-bottom: unset !important;
            }
            
            #reference-image-container {
                flex-shrink: unset !important;
                padding: unset !important;
                text-align: unset !important;
                background: unset !important;
                border-bottom: unset !important;
                position: unset !important;
                top: unset !important;
                left: unset !important;
                max-width: unset !important;
                width: unset !important;
            }
            
            /* Adjust mobile container for smaller screens */
            .product-carousel-section {
                min-height: 50vh !important;
                height: 50vh !important;
            }
            
            #mobile-canvas-container {
                min-height: 300px !important;
            }
        }

        /* ======================================
           UNIFIED ECOMMERCE LAYOUT STYLES
           ====================================== */
        
        /* Main Ecommerce Layout Container */
        .ecommerce-layout {
            display: flex;
            width: 100%;
            height: auto;
            min-height: auto;
            overflow: hidden;
        }
        
        /* Desktop Layout (768px+) */
        @media (min-width: 768px) {
            .ecommerce-layout {
                flex-direction: row;
            }
            
            .product-gallery-section {
                flex: 0 0 60%;
                width: 60%;
                height: auto;
                min-height: 60vh;
            }
            
            .product-details-section {
                flex: 1;
                min-width: 0;
                height: auto;
                min-height: 60vh;
                overflow-y: visible;
                background: #ffffff;
                border-left: 1px solid #e2e8f0;
            }
            
            .desktop-only {
                display: block !important;
            }
            
            .mobile-only {
                display: none !important;
            }
        }
        
        /* Mobile Layout (< 768px) */
        @media (max-width: 767px) {
            .ecommerce-layout {
                flex-direction: column;
            }
            
            .product-gallery-section {
                flex: 0 0 60vh;
                height: 60vh;
                order: 2;
            }
            
            .product-details-section {
                flex: 1;
                overflow-y: auto;
                background: #ffffff;
                border-top: 1px solid #e2e8f0;
                order: 1;
            }
            
            .desktop-only {
                display: none !important;
            }
            
            .mobile-only {
                display: block !important;
            }
        }
        
        /* ======================================
           PRODUCT GALLERY SECTION
           ====================================== */
        
        .product-gallery-section {
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            position: relative;
    min-height: 90vh;
        }
        
        .main-product-viewer {
            flex: 1;
            position: relative;
            background: transparent;
            overflow: hidden;
    min-height: 80vh;
    height: 100%;
            aspect-ratio: 1 / 1;
    max-height: none;
        }
        
        #canvas-container {
            width: 100% !important;
            height: 100% !important;
            aspect-ratio: inherit;
            background: transparent !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        #canvas-container canvas {
            width: 100% !important;
            height: 100% !important;
            display: block !important;
        }
        
        /* Scene Title (Desktop Only) */
        .scene-title-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1003;
            background: rgba(255,255,255,0.95);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }
        
        .scene-title-container h2 {
            color: #2d3748;
            font-weight: 800;
            font-size: 1.8em;
            margin: 0;
        }
        
        .scene-title-container p {
            color: #718096;
            font-size: 0.9em;
            margin: 5px 0 0 0;
        }
        
        /* ======================================
           PRODUCT CAROUSEL
           ====================================== */
        
        .product-carousel {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: #ffffff;
            border-top: 1px solid #e2e8f0;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .product-carousel::-webkit-scrollbar {
            display: none;
        }
        
        .carousel-thumbnail {
            flex-shrink: 0;
            min-width: 80px;
            height: 80px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            gap: 4px;
        }
        
        .carousel-thumbnail:hover {
            border-color: #1d4ed8;
            background: #e8eefc;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(29, 78, 216, 0.25);
        }
        
        .carousel-thumbnail.active {
            border-color: #1d4ed8;
            background: #1d4ed8;
            color: white;
            box-shadow: 0 4px 12px rgba(29, 78, 216, 0.3);
        }
        
        .carousel-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .carousel-thumbnail.active .carousel-image {
            filter: brightness(1.1) contrast(1.1);
        }
        
        .carousel-3d-icon {
            font-size: 1.8em;
            line-height: 1;
            color: #1d4ed8;
        }
        
        .carousel-thumbnail.active .carousel-3d-icon {
            color: white;
        }
        
        .carousel-icon {
            font-size: 1.5em;
            line-height: 1;
        }
        
        .carousel-label {
            font-size: 0.7em;
            font-weight: 600;
            text-align: center;
            line-height: 1;
            margin-top: 4px;
        }
        
        @media (max-width: 767px) {
            .product-carousel {
                gap: 8px;
                padding: 12px;
            }
            
            .carousel-thumbnail {
                min-width: 60px;
                height: 60px;
            }
            
            .carousel-image {
                border-radius: 6px;
            }
            
            .carousel-icon {
                font-size: 1.2em;
            }
            
            .carousel-label {
                font-size: 0.6em;
            }
        }
        
        /* ======================================
           PRODUCT DETAILS SECTION
           ====================================== */
        
        .product-details-section {
            padding: 16px 20px;
            color: #2d3748;
        }
        
        @media (max-width: 767px) {
            .product-details-section {
                padding: 16px;
            }
        }
        
        /* Product Header */
        .product-header {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .product-title {
            font-size: 2.2em;
            font-weight: 700;
            color: #2d3748;
            margin: 0 0 12px 0;
            line-height: 1.2;
        }
        
        .product-price {
            font-size: 1.8em;
            font-weight: 600;
            color: #1d4ed8;
            margin: 0 0 8px 0;
        }
        
        .product-subtitle {
            font-size: 1em;
            color: #718096;
            margin: 0;
            font-weight: 400;
        }
        
        @media (max-width: 767px) {
            .product-header {
                margin-bottom: 24px;
                padding-bottom: 20px;
            }
            
            .product-title {
                font-size: 1.8em;
            }
            
            .product-price {
                font-size: 1.5em;
            }
        }
        
        /* ======================================
           PRODUCT OPTIONS
           ====================================== */
        
        .product-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .option-label {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95em;
            margin: 0;
        }
        
        /* Option Buttons */
        .option-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .option-button {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #ffffff;
            color: #2d3748;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .option-button:hover {
            border-color: #1d4ed8;
            background: #e8eefc;
        }
        
        .option-button.active {
            border-color: #1d4ed8;
            background: #1d4ed8;
            color: white;
        }
        
        .option-icon {
            font-size: 1.1em;
        }
        
        @media (max-width: 767px) {
            .option-button {
                min-width: 100px;
                padding: 10px 14px;
                font-size: 0.9em;
            }
        }
        
        /* Option Select */
        .option-select {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #ffffff;
            color: #2d3748;
            font-size: 0.95em;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }
        
        .option-select:hover,
        .option-select:focus {
            border-color: #1d4ed8;
            outline: none;
        }
        
        /* Option Checkbox */
        .option-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 12px 0;
        }
        
        .option-checkbox input[type="checkbox"] {
            display: none;
        }
        
        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 4px;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .option-checkbox input[type="checkbox"]:checked + .checkmark {
            background: #1d4ed8;
            border-color: #1d4ed8;
        }
        
        .option-checkbox input[type="checkbox"]:checked + .checkmark::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .checkbox-label {
            font-weight: 500;
            color: #2d3748;
        }
        
        .checkbox-price {
            color: #1d4ed8;
            font-weight: 600;
            margin-left: auto;
        }
        
        /* ======================================
           ACTION BUTTONS CONTAINER
           ====================================== */
        
        .action-buttons-container {
            display: flex;
            gap: 16px;
            margin-top: 24px;
        }
        
        .action-buttons-container .add-photo-section,
        .action-buttons-container .imagine-section {
            flex: 1;
            margin-top: 0;
            width: 50%;
            min-width: 0;
        }

        /* CTA row floating over scene */
        .post-layout-actions {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            margin: 0;
            max-width: 620px;
            width: 92%;
            padding: 6px 8px;
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: stretch;
            flex-wrap: wrap;
            z-index: 1200;
            pointer-events: none; /* allow underlying scene interaction except buttons */
        }

        .post-layout-actions .add-photo-section,
        .post-layout-actions .imagine-section {
            flex: 1 1 220px;
            min-width: 200px;
            max-width: 260px;
            pointer-events: auto; /* re-enable on interactive cards */
            background: var(--bg-stone);
            color: var(--ink);
            border: 1px solid rgba(43,43,43,0.12);
            border-radius: 12px;
            box-shadow: 0 10px 24px rgba(0,0,0,0.18);
        }
        
        /* ======================================
           ADD PHOTO SECTION
           ====================================== */
        
        .add-photo-section {
            margin-top: 24px;
            padding: 14px;
            background: var(--bg-stone);
            color: var(--ink);
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 24px rgba(0,0,0,0.18);
            border: 1px solid rgba(43,43,43,0.12);
        }
        
        .add-photo-button {
            width: 100%;
            height: 52px;
            background: var(--oxblood);
            color: var(--bg-parchment);
            border: 1px solid var(--oxblood);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            backdrop-filter: blur(10px);
        }
        
        .add-photo-button:hover {
    background: var(--oxblood-strong);
            transform: translateY(-2px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.16);
        }
        
        .add-photo-button:active {
            transform: translateY(0);
        }
        
        .button-icon {
            font-size: 1.3em;
        }
        
        .button-arrow {
            font-size: 1.2em;
            margin-left: auto;
        }
        
        .photo-help-text {
            color: var(--ink);
            margin: 12px 0 0 0;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        @media (max-width: 767px) {
            .add-photo-section {
                margin-top: 20px;
                padding: 16px;
            }
            
            .add-photo-button {
                padding: 14px 20px;
                font-size: 1em;
            }
        }
        
        /* ======================================
           IMAGINE SECTION STYLES
           ====================================== */
        
        .imagine-section {
            margin-top: 24px;
            padding: 14px;
            background: var(--bg-stone);
            color: var(--ink);
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 24px rgba(0,0,0,0.18);
            border: 1px solid rgba(43,43,43,0.12);
        }
        
        .imagine-button {
            width: 100%;
            height: 52px;
            background: var(--oxblood);
            color: var(--bg-parchment);
            border: 1px solid var(--oxblood);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            backdrop-filter: blur(10px);
        }

        /* CTA attention pulse (limited) */
        @keyframes ctaPulse {
            0% { box-shadow: 0 0 0 rgba(16, 23, 43, 0); transform: translateY(0); }
            30% { box-shadow: 0 0 18px rgba(255, 255, 255, 0.25), 0 8px 24px rgba(0,0,0,0.28); transform: translateY(-2px); }
            60% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.18), 0 6px 18px rgba(0,0,0,0.2); transform: translateY(-1px); }
            100% { box-shadow: 0 0 0 rgba(16, 23, 43, 0); transform: translateY(0); }
        }

        .cta-pulse-once {
            animation: ctaPulse 1.8s ease-in-out 3;
        }

        /* Demo welcome breathe */
        @keyframes demoBreathe {
            0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
            40% { transform: translate(-50%, -50%) scale(1.05); box-shadow: 0 8px 18px rgba(0,0,0,0.35); }
            70% { transform: translate(-50%, -50%) scale(1.02); box-shadow: 0 6px 16px rgba(0,0,0,0.32); }
            100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        }

        #demo-message.demo-breathe {
            animation: demoBreathe 1.6s ease-in-out 5;
        }
        
        .imagine-button:hover {
            background: var(--oxblood-strong);
            transform: translateY(-2px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.16);
        }
        
        .imagine-help-text {
            color: var(--ink);
            margin: 12px 0 0 0;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .ai-prompt-container {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            text-align: left;
        }
        
        .prompt-input-group textarea {
            width: 100%;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.95em;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        
        .prompt-input-group textarea:focus {
            outline: none;
            border-color: #1d4ed8;
        }
        
        .prompt-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            justify-content: flex-end;
        }
        
        .prompt-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .prompt-button.primary {
            background: var(--oxblood);
            color: var(--bg-parchment);
            border: 1px solid var(--oxblood);
        }
        
        .prompt-button.primary:hover {
            background: var(--oxblood-strong);
            border-color: #5b1919;
            transform: translateY(-1px);
        }
        
        .prompt-button.secondary {
            background: var(--bg-stone);
            color: var(--ink);
            border: 1px solid rgba(43,43,43,0.16);
        }
        
        .prompt-button.secondary:hover {
            background: #ccc5ba;
        }
        
        @media (max-width: 767px) {
            .action-buttons-container {
                flex-direction: row;
                gap: 8px;
            }
            
            .action-buttons-container .add-photo-section,
            .action-buttons-container .imagine-section {
                width: 50%;
                min-width: 0;
            }
            
            .add-photo-section {
                margin-top: 0;
                padding: 12px;
            }
            
            .add-photo-button {
                height: 50px;
                padding: 12px 16px;
                font-size: 0.9em;
            }
            
            .photo-help-text {
                font-size: 0.8em;
                margin: 8px 0 0 0;
                color: var(--ink);
            }
            
            .imagine-section {
                margin-top: 0;
                padding: 12px;
            }
            
            .imagine-button {
                height: 50px;
                padding: 12px 16px;
                font-size: 0.9em;
            }
            
            .imagine-help-text {
                font-size: 0.8em;
                margin: 8px 0 0 0;
            }
            
            .prompt-buttons {
                flex-direction: column;
            }
            
            .prompt-button {
                justify-content: center;
            }
        }
        
        /* ======================================
           UI CONTROLS SECTION (Desktop Only)
           ====================================== */
        
        .ui-controls-section {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
        }
        
        .controls-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3748;
            margin: 0 0 16px 0;
        }
        
        #ui-menu-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Hide Shopify cart toggle */
        [data-shopify-button-component],
        .shopify-buy__cart-toggle,
        .shopify-buy__cart-toggle-wrapper,
        button[data-shopify-cart-toggle],
        [id*="shopify-cart"],
        [class*="shopify-buy__cart-toggle"],
        [class*="shopify-buy-frame"][class*="cart"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* ============================
           Responsive refinements
           ============================ */
        :root {
            --section-padding: clamp(12px, 3vw, 28px);
            --section-max-width: 1080px;
            --brand-navy: var(--oxblood);
        }

        body, html {
            width: 100% !important;
            max-width: 100% !important;
            overflow-x: hidden !important;
        }

        #main-site-container {
            width: 100% !important;
            max-width: 100% !important;
            overflow-x: hidden !important;
        }

        /* Normalize old accent blues to primary accent */
        [style*="#1d4ed8"] {
            background-color: var(--brand-navy) !important;
            border-color: var(--brand-navy) !important;
            color: #f9fafb !important;
        }

        .hero-container {
            min-height: auto !important;
            padding: var(--section-padding) 0 !important;
        }

        .hero-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: clamp(16px, 3vw, 40px);
            align-items: center;
            padding: var(--section-padding);
            max-width: var(--section-max-width);
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .hero-text-col {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .hero-cta-stack {
            width: min(620px, 100%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            margin: 0 auto;
        }

        /* Mobile persistent add-photo button */
        .mobile-add-photo-fab {
            position: fixed;
            bottom: 14px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 12px 18px;
            border-radius: 999px;
            border: 1px solid var(--oxblood);
            background: var(--oxblood);
            color: var(--bg-parchment);
            font-weight: 700;
            font-size: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.18);
            z-index: 11000;
            cursor: pointer;
            text-decoration: none;
        }

        /* Social footer */
        .social-footer {
            margin: 0 auto;
            padding: 22px 16px 32px;
            width: 100%;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            color: var(--ink);
            border-top: none;
            background: var(--bg-stone);
            box-sizing: border-box;
        }

        .social-footer a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 12px;
            background: var(--bg-stone);
            border: none;
            color: var(--ink);
            font-weight: 700;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .social-footer a:hover {
            background: var(--bg-stone);
            border-color: rgba(43,43,43,0.12);
            color: var(--ink);
            transform: none;
            box-shadow: none;
        }

        @media (min-width: 769px) {
            .mobile-add-photo-fab {
                display: none !important;
            }
        }

        .hero-highlights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            width: 100%;
        }

        .hero-image-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            justify-content: center;
        }

        .hero-media-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .hero-sample-image {
            width: min(260px, 42vw);
            height: auto;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 4px solid rgba(255,255,255,0.3);
        }

        .hero-image-caption {
            margin: 0;
            color: #ffffff;
            font-weight: 700;
            letter-spacing: 0.03em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.95em;
            flex-wrap: wrap;
        }

        @media (max-width: 1024px) {
            .navbar {
                grid-template-columns: 1fr;
                justify-items: center;
                padding: 12px 18px;
            }
            .navbar-nav {
                justify-content: center;
            }
            .hero-title {
                font-size: clamp(2.4rem, 4.5vw, 3.2rem);
            }
            .hero-subtitle {
                font-size: clamp(1rem, 2.2vw, 1.3rem);
            }
            .hero-logo {
                margin-top: 18px;
                margin-bottom: 8px;
            }
        }

        @media (max-width: 768px) {
            .hero-container {
                padding: 4px 0 8px 0 !important;
            }
            .hero-grid {
                padding: 8px 6px !important;
                gap: clamp(8px, 1.8vw, 14px);
                max-width: 100% !important;
            }
            .hero-image-row {
                flex-direction: row;
                flex-wrap: nowrap;
                gap: 4px !important;
            }
            .hero-media-col {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 6px !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .hero-media-col .hero-image-row {
                order: 1 !important;
                width: 100% !important;
                justify-content: center !important;
            }
            .hero-media-col .hero-upload-btn {
                order: 2 !important;
                width: min(220px, 90vw);
                align-self: center !important;
                margin: 0 !important;
            }
            .hero-highlights {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 8px;
            }
            .hero-highlights > div {
                padding: 8px 10px !important;
                border-radius: 14px !important;
            }
            .hero-highlights > div span {
                font-size: 0.9em !important;
                font-weight: 500 !important;
            }
            .hero-sample-image {
                width: min(200px, 44vw);
            }
            .navbar-brand img {
                height: 44px;
            }
        }
    </style>
    <!-- Cropper.js CSS -->
    <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <!-- dat.GUI -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>
</head>
<body>

    
    <!-- Mobile Debug Panel -->
    <div id="mobile-debug" style="display:none;position:fixed;top:10px;right:10px;background:rgba(0,0,0,0.9);color:white;padding:15px;border-radius:8px;z-index:9999;max-width:300px;font-family:monospace;font-size:12px;">
        <div id="debug-content"></div>
        <button onclick="this.parentElement.style.display='none'" style="float:right;background:red;color:white;border:none;padding:2px 6px;margin-top:5px;">X</button>
    </div>
    
    <!-- Navigation Bar -->
    <nav class="navbar" id="navbar">
        <a href="#" class="navbar-brand" onclick="event.preventDefault(); scrollToSection('hero-container'); return false;">
            <img src="/IKSlogo_transparentbg.png" alt="Image Keepsake Studio Logo">
            <span>Image Keepsake Studio</span>
        </a>
        <ul class="navbar-nav">
            <li><a href="#" onclick="event.preventDefault(); scrollToSection('hero-container'); return false;">About</a></li>
            <li><a href="#" onclick="event.preventDefault(); scrollToSection('scene-container'); return false;">Studio</a></li>
            <li><a href="#" onclick="event.preventDefault(); scrollToSection('upload-container'); return false;">Process</a></li>
        </ul>
    </nav>

    <!-- Mobile persistent add-photo button -->
    <button id="mobile-add-photo-fab" class="mobile-add-photo-fab" onclick="openUploadFromHero(); return false;" aria-label="Add a photo" style="display:none;">
         Add a Photo
    </button>

    <!-- Main Site Container -->
    <div id="main-site-container" style="width: 100%; min-height: 100vh; position: relative; margin: 0; padding: 0; overflow-x: hidden;">
        
        <!-- Hero Section -->
        <div id="hero-container" class="hero-container">
            <div class="hero-grid">
                <!-- Left: Text Content -->
                <div class="hero-text-col">
                    <h1 class="hero-title" style="max-width: 520px; text-align: center; margin: 0 auto;">
                        <img class="hero-logo" src="/IKSlogo_transparentbg.png" alt="Image Keepsake Studio" style="width: 360px; max-width: 100%; height: auto; display: block; margin: 0 auto;" loading="lazy" decoding="async">
                    </h1>
                    <p class="hero-subtitle" style="max-width: 550px; text-align: center; margin: 12px auto 0;">Upload your cherished memories and transform them into stunning, wearable jewelry. Make <span style="background: var(--highlight); color: var(--ink); padding: 2px 6px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);">once in a lifetime</span> last <em>forever.</em></p>
                    <div style="margin: 16px auto 8px; text-align: center;">
                        <label for="theme-selector" style="font-weight: 700; color: var(--ink); margin-right: 8px;">Theme</label>
                        <select id="theme-selector" style="padding: 10px 12px; border: 1px solid rgba(43,43,43,0.2); border-radius: 10px; background: var(--bg-stone); color: var(--ink); font-weight: 600; min-width: 220px; box-shadow: 0 6px 14px rgba(0,0,0,0.08);">
                            <option value="studio-moss">Studio Moss (Current)</option>
                            <option value="heritage-navy">Heritage Navy (Previous)</option>
                            <option value="rose-gold">Rose Gold & Ivory</option>
                            <option value="emerald-gold">Emerald & Gold</option>
                            <option value="onyx-gold">Onyx & Gold</option>
                            <option value="pearl-champagne">Pearl & Champagne</option>
                            <option value="sapphire-silver">Sapphire & Silver</option>
                            <option value="charcoal-sand">Charcoal & Sand</option>
                        </select>
                    </div>
                    <div class="hero-cta-stack">
                        <div class="hero-highlights">
                            <div style="background: var(--bg-stone); padding: 12px 16px; border-radius: 20px; text-align: center; box-shadow: 0 6px 14px rgba(0,0,0,0.12); border: 1px solid rgba(43,43,43,0.08);">
                                <span style="font-weight: 600; color: var(--ink); font-size: 1.1em;"> Quality Craftsmanship</span>
                            </div>
                            <div style="background: var(--bg-stone); padding: 12px 16px; border-radius: 20px; text-align: center; box-shadow: 0 6px 14px rgba(0,0,0,0.12); border: 1px solid rgba(43,43,43,0.08);">
                                <span style="font-weight: 600; color: var(--ink); font-size: 1.1em;"> Fast Delivery</span>
                            </div>
                            <div style="background: var(--bg-stone); padding: 12px 16px; border-radius: 20px; text-align: center; box-shadow: 0 6px 14px rgba(0,0,0,0.12); border: 1px solid rgba(43,43,43,0.08);">
                                <span style="font-weight: 600; color: var(--ink); font-size: 1.1em;"> Precious Results</span>
                            </div>
                            <div style="background: var(--bg-stone); padding: 12px 16px; border-radius: 20px; text-align: center; box-shadow: 0 6px 14px rgba(0,0,0,0.12); border: 1px solid rgba(43,43,43,0.08);">
                                <span style="font-weight: 600; color: var(--ink); font-size: 1.1em;"> Custom Design</span>
                            </div>
                            <div style="background: var(--bg-stone); padding: 12px 16px; border-radius: 20px; text-align: center; box-shadow: 0 6px 14px rgba(0,0,0,0.12); border: 1px solid rgba(43,43,43,0.08);">
                                <span style="font-weight: 600; color: var(--ink); font-size: 1.1em;"> Secure Payment</span>
                            </div>
                            <div style="background: var(--bg-stone); padding: 12px 16px; border-radius: 20px; text-align: center; box-shadow: 0 6px 14px rgba(0,0,0,0.12); border: 1px solid rgba(43,43,43,0.08);">
                                <span style="font-weight: 600; color: var(--ink); font-size: 1.1em;"> 5-Star Reviews</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right: Sample Images -->
                <div class="hero-media-col" style="text-align: center; margin-top: -10px; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                    <div class="hero-image-row">
                        <div style="position: relative; display: inline-block;">
                            <img class="hero-sample-image" src="/sleddingScene_before.png" alt="Winter sledding scene" loading="lazy" decoding="async">
                        </div>
                        <div style="position: relative; display: inline-block;">
                            <img class="hero-sample-image" src="/samplePendant.png" alt="Sample Pendant Alternate View" loading="lazy" decoding="async">
                        </div>
                    </div>
                    <button class="hero-upload-btn" onclick="openUploadFromHero(); return false;">
                        Upload a Photo to Get Started
                    </button>
                </div>
        </div>
        </div>

        <script>
            function openUploadFromHero() {
                try {
                    scrollToSection('scene-container');
                } catch (e) {
                    console.warn('scrollToSection unavailable', e);
                }
                const fileInput = document.getElementById('file-input');
                if (fileInput) {
                    // Small delay to allow scroll and avoid blocked click
                    setTimeout(() => fileInput.click(), 120);
                }
            }

            function updateMobileAddPhotoFab(hasImage) {
                const fab = document.getElementById('mobile-add-photo-fab');
                if (!fab) return;
                const isMobile = window.matchMedia('(max-width: 768px)').matches;
                fab.style.display = !hasImage && isMobile ? 'flex' : 'none';
            }

            document.addEventListener('DOMContentLoaded', () => {
                const fileInput = document.getElementById('file-input');
                if (fileInput) {
                    fileInput.addEventListener('change', () => {
                        const hasImage = fileInput.files && fileInput.files.length > 0;
                        updateMobileAddPhotoFab(hasImage);
                    });
                }

                // Initial state: assume no image selected yet
                updateMobileAddPhotoFab(false);

                // Re-evaluate on resize/orientation change
                window.addEventListener('resize', () => {
                    const hasImage = fileInput && fileInput.files && fileInput.files.length > 0;
                    updateMobileAddPhotoFab(hasImage);
                });
            });

            // FAQ toggle handling
            document.addEventListener('DOMContentLoaded', () => {
                const faqButtons = document.querySelectorAll('.faq-toggle');
                const faqList = document.getElementById('faq-list');
                const faqSubtext = document.getElementById('faq-subtext');
                const faqContainer = document.getElementById('faq-container');
                const faqToggleAllBtn = document.getElementById('faq-toggle-all');
                const addPhotoBtn = document.getElementById('add-photo-btn');
                const imagineBtn = document.getElementById('imagine-btn');
                const themeSelector = document.getElementById('theme-selector');
                let faqCollapsed = true;
            const THEME_KEY = 'iks-theme';
            const getVar = (name, fallback) => {
                const val = getComputedStyle(document.documentElement).getPropertyValue(name)?.trim();
                return val || fallback;
            };
            const restyleBuyNowButtons = () => {
                const accent = getVar('--oxblood', '#9C8F82');
                const accentStrong = getVar('--oxblood-strong', '#7C6F64');
                const paper = getVar('--bg-parchment', '#F3EFE8');
                document.querySelectorAll('iframe').forEach(iframe => {
                    const doc = iframe.contentDocument || iframe.contentWindow?.document;
                    if (!doc) return;
                    const btns = doc.querySelectorAll('button, [role="button"], a[href*="cart"]');
                    btns.forEach(button => {
                        const text = button.textContent?.trim().toLowerCase() || '';
                        const aria = button.getAttribute('aria-label')?.toLowerCase() || '';
                        if (!text.includes('buy') && !aria.includes('buy')) return;
                        button.style.borderRadius = '10px';
                        button.style.padding = '12px 16px';
                        button.style.minHeight = '48px';
                        button.style.minWidth = '160px';
                        button.style.fontWeight = '700';
                        button.style.letterSpacing = '0.01em';
                        button.style.fontSize = '14px';
                        button.style.lineHeight = '1.15';
                        button.style.background = accent;
                        button.style.color = paper;
                        button.style.border = `1px solid ${accent}`;
                        button.style.boxShadow = '0 8px 18px rgba(0, 0, 0, 0.18)';
                        button.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease';
                        button.style.display = 'inline-block';
                        button.onmouseenter = () => {
                            button.style.transform = 'translateY(-2px)';
                            button.style.boxShadow = '0 10px 22px rgba(0, 0, 0, 0.24)';
                            button.style.background = accentStrong;
                            button.style.borderColor = accentStrong;
                        };
                        button.onmouseleave = () => {
                            button.style.transform = 'translateY(0)';
                            button.style.boxShadow = '0 8px 18px rgba(0, 0, 0, 0.18)';
                            button.style.background = accent;
                            button.style.borderColor = accent;
                        };
                    });
                });
            };
            const THEMES = {
                'studio-moss': {
                    '--bg-parchment': '#F3EFE8',
                    '--bg-stone': '#D8D1C7',
                    '--ink': '#2B2B2B',
                    '--oxblood': '#9C8F82',
                    '--oxblood-strong': '#7C6F64',
                    '--bronze': '#B8874B',
                    '--highlight': '#E8D9C8'
                },
                'heritage-navy': {
                    '--bg-parchment': '#f8f9fa',
                    '--bg-stone': '#e5e7eb',
                    '--ink': '#0b1220',
                    '--oxblood': '#1e2b45',          // navy accent
                    '--oxblood-strong': '#10172b',    // deeper navy
                    '--bronze': '#b8a07d',
                    '--highlight': '#D1B277'
                },
                'rose-gold': {
                    '--bg-parchment': '#F7F2EC',
                    '--bg-stone': '#E6DBCF',
                    '--ink': '#2B2B2B',
                    '--oxblood': '#C98C7B',
                    '--oxblood-strong': '#B27665',
                    '--bronze': '#D9B08C',
                    '--highlight': '#F7E1D8'
                },
                'emerald-gold': {
                    '--bg-parchment': '#F2F0EA',
                    '--bg-stone': '#DCD4C7',
                    '--ink': '#233129',
                    '--oxblood': '#3C6E58',
                    '--oxblood-strong': '#2F5A47',
                    '--bronze': '#B08C52',
                    '--highlight': '#D7E5D7'
                },
                'onyx-gold': {
                    '--bg-parchment': '#F4F1EB',
                    '--bg-stone': '#DBD4C8',
                    '--ink': '#1F1F1F',
                    '--oxblood': '#3A3A3A',
                    '--oxblood-strong': '#2E2E2E',
                    '--bronze': '#C4A46A',
                    '--highlight': '#E7D8B7'
                },
                'pearl-champagne': {
                    '--bg-parchment': '#F8F5F0',
                    '--bg-stone': '#E4DBCE',
                    '--ink': '#2F2A28',
                    '--oxblood': '#C4AFA0',
                    '--oxblood-strong': '#AE9A8C',
                    '--bronze': '#C6A66C',
                    '--highlight': '#F2E3D0'
                },
                'sapphire-silver': {
                    '--bg-parchment': '#F2F4F7',
                    '--bg-stone': '#DFE3EA',
                    '--ink': '#1F2733',
                    '--oxblood': '#3F5E93',
                    '--oxblood-strong': '#324C77',
                    '--bronze': '#B7B7C2',
                    '--highlight': '#D8E6FF'
                },
                'charcoal-sand': {
                    '--bg-parchment': '#F5F1EB',
                    '--bg-stone': '#E2D6C7',
                    '--ink': '#2B2B2B',
                    '--oxblood': '#6B6256',
                    '--oxblood-strong': '#574F44',
                    '--bronze': '#AF9874',
                    '--highlight': '#E6D9C8'
                }
            };
            
            const applyTheme = (name) => {
                const theme = THEMES[name] || THEMES['studio-moss'];
                Object.entries(theme).forEach(([key, value]) => {
                    document.documentElement.style.setProperty(key, value);
                });
                if (themeSelector) themeSelector.value = name;
                localStorage.setItem(THEME_KEY, name);
                restyleBuyNowButtons();
            };
            
            const savedTheme = localStorage.getItem(THEME_KEY) || 'studio-moss';
            applyTheme(savedTheme);
            
            if (themeSelector) {
                themeSelector.addEventListener('change', (e) => {
                    applyTheme(e.target.value);
                });
            }
                
                const updateFaqVisibility = () => {
                    const listDisplay = faqCollapsed ? 'none' : 'flex';
                    if (faqList) faqList.style.display = listDisplay;
                    if (faqSubtext) faqSubtext.style.display = faqCollapsed ? 'none' : 'block';
                    if (faqContainer) faqContainer.setAttribute('aria-expanded', faqCollapsed ? 'false' : 'true');
                    if (faqToggleAllBtn) {
                        faqToggleAllBtn.textContent = faqCollapsed ? '+' : '';
                        faqToggleAllBtn.setAttribute('aria-expanded', faqCollapsed ? 'false' : 'true');
                    }
                };

                // Gentle CTA pulse (once)
                const pulseButtonsOnce = () => {
                    const alreadyPulsed = sessionStorage.getItem('ctaPulsed') === 'true';
                    if (alreadyPulsed) return;
                    if (addPhotoBtn) addPhotoBtn.classList.add('cta-pulse-once');
                    if (imagineBtn) imagineBtn.classList.add('cta-pulse-once');
                    sessionStorage.setItem('ctaPulsed', 'true');
                    const totalDurationMs = 1800 * 3 + 200; // animation duration * iterations + buffer
                    setTimeout(() => {
                        if (addPhotoBtn) addPhotoBtn.classList.remove('cta-pulse-once');
                        if (imagineBtn) imagineBtn.classList.remove('cta-pulse-once');
                    }, totalDurationMs);
                };
                
                faqButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const answer = btn.nextElementSibling;
                        const isOpen = answer && answer.style.display === 'block';
                        // Close all
                        faqButtons.forEach(b => {
                            const a = b.nextElementSibling;
                            if (a) {
                                a.style.display = 'none';
                                b.querySelector('span[aria-hidden="true"]').textContent = '+';
                            }
                        });
                        // Toggle current
                        if (answer) {
                            answer.style.display = isOpen ? 'none' : 'block';
                            btn.querySelector('span[aria-hidden="true"]').textContent = isOpen ? '+' : '';
                        }
                    });
                });
                
                if (faqToggleAllBtn) {
                    faqToggleAllBtn.addEventListener('click', () => {
                        faqCollapsed = !faqCollapsed;
                        updateFaqVisibility();
                    });
                }
                
                updateFaqVisibility();
                pulseButtonsOnce();
            });
        </script>

        <!-- Three.js Scene Section -->
        <div id="scene-container" class="scene-container">
            <!-- Unified Shopify-style Ecommerce Layout -->
            <div class="ecommerce-layout">
                <!-- Product Gallery Section (3D Viewer + Carousel) -->
                <div class="product-gallery-section">
                                        <!-- Main Product Viewer (3D Canvas + Image Viewer) -->
                    <div class="main-product-viewer">
                        <!-- 3D Scene Container -->
                        <div id="canvas-container" style="width: 100%; height: 100%; background: transparent; position: relative; display: block;">
                            <!-- 3D Canvas will be moved here -->
                            
                            <!-- 3D Scene Title removed for cleaner view -->
                            
                            <!-- Ruler Overlay Removed -->
                            
                            <!-- Invert Depth Button - positioned within canvas -->
                            <button id="invert-relief-btn" style="position: absolute; top: 16px; right: 16px; z-index: 1001; background: rgba(255, 255, 255, 0.95); border: 2px solid rgba(0, 0, 0, 0.7); color: #000000; font-size: 13px; cursor: pointer; padding: 9px 16px; border-radius: 8px; font-weight: 600; backdrop-filter: blur(10px); box-shadow: 0 4px 10px rgba(0,0,0,0.25); transition: all 0.25s ease; display: none;">
                                 Invert Design
                            </button>
                            
                            <!-- Demo Message -->
                            <div id="demo-message" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-stone); color: var(--ink); padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; z-index: 1100; pointer-events: auto; cursor: pointer; backdrop-filter: blur(4px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: none; text-align: center; max-width: 400px; display: none;">
                                <div style="margin-bottom: 4px;"><strong>WELCOME</strong></div>
                                <div style="font-size: 12px; opacity: 0.9; line-height: 1.3;">
                                    This is our interactive pendant designer. Upload a photo or use our AI generator below to get started.
                                    <p>Click this message to continue.</p>
                                </div>
                            </div>
                            
                            <style>
                                @media (max-width: 768px) {
                                    #demo-message {
                                        top: 50% !important;
                                        left: 50% !important;
                                        transform: translate(-50%, -50%) !important;
                                        padding: 8px 12px !important;
                                        font-size: 11px !important;
                                        max-width: 280px !important;
                                    }
                                    
                                    #demo-message > div:first-child {
                                        font-size: 12px !important;
                                        margin-bottom: 3px !important;
                                    }
                                    
                                    #demo-message > div:last-child {
                                        font-size: 9px !important;
                                    }
                                }
                            </style>
                        
                            <!-- CTA row floating over scene -->
                            <div class="post-layout-actions">
                            <div class="add-photo-section">
                                <button class="add-photo-button" id="add-photo-btn">
                                    <span class="button-icon"></span>
                                    <span class="button-text">Add a Photo</span>
                                </button>
                                <p class="photo-help-text">Precious Moments Made Eternal</p>
                            </div>
                            
                            <div class="imagine-section">
                                <button class="imagine-button" id="imagine-btn">
                                    <span class="button-icon"></span>
                                    <span class="button-text">Imagine with AI</span>
                                </button>
                                <p class="imagine-help-text">Dream It, Wear It</p>
                                
                                <!-- AI Prompt Input (Hidden by default) -->
                                <div class="ai-prompt-container" id="ai-prompt-container" style="display: none;">
                                    <div class="prompt-input-group">
                                        <textarea id="ai-prompt-input" placeholder="Describe what you want to create... (e.g., 'a majestic golden eagle in flight', 'abstract geometric patterns', 'a beautiful rose garden')" rows="3"></textarea>
                                        <div class="prompt-buttons">
                                            <button class="prompt-button primary" id="generate-ai-btn">
                                                <span class="button-icon"></span>
                                                Generate
                                            </button>
                                            <button class="prompt-button secondary" id="cancel-ai-btn">Cancel</button>
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        <!-- Image Viewer Container -->
                        <div id="image-viewer-container" style="width: 100%; height: 100%; background: transparent; position: relative; display: none;">
                            <img id="main-image-viewer" src="" alt="Product View" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">
                        </div>
                    </div>
                </div>
                
                <!-- Product Details Section -->
                <div class="product-details-section">
                    <!-- Product Options -->        
                    <div class="product-options">
                        <!-- Shopify Buy Button -->
                        <div class="option-group" style="margin-top: 20px;">
                            <div id='product-component-1764405426589'></div>
                        </div>
                        
                        <!-- Debug Export STL Section -->
                        <div class="debug-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="debug-button" id="debug-export-stl-btn" style="background: #e53e3e; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(229, 62, 62, 0.4);">
                                    <span class="button-icon"></span>
                                    <span class="button-text">Export STL (Debug)</span>
                                </button>
                                <button class="debug-button" id="export-pendant-only-btn" style="background: #1d4ed8; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(29, 78, 216, 0.4);">
                                    <span class="button-icon"></span>
                                    <span class="button-text">Export Pendant Only</span>
                                </button>
                            </div>
                            <p class="debug-help-text" style="color: #718096; font-size: 12px; margin-top: 5px;">Export current 3D model as STL file</p>
                        </div>

                    </div>
                    

                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div id="upload-container" class="upload-container">
        <div id="drop-zone" style="padding: 20px 24px; width: 100%; max-width: 1100px; min-height: 80vh; margin: 0 auto; display: flex; flex-direction: column; box-sizing: border-box;">
            <input type="file" id="file-input" accept="image/*" style="display: none;">
            <!-- Main Content Section (2/3 height) -->
            <div style="flex: 2; width: 100%; overflow-y: visible; overflow-x: visible;">
                <div style="width: 100%;">
                <!-- Section Title -->
                <div style="text-align: center; margin: 0 auto 20px auto; width: 100%; max-width: 960px; background: var(--bg-stone); padding: 18px 18px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); box-sizing: border-box; border: 1px solid rgba(43,43,43,0.08);">
                    <h2 style="color: var(--ink); font-weight: 800; font-size: 2em; margin-bottom: 10px;">How It Works</h2>
                    <p style="color: rgba(43,43,43,0.8); font-size: 1em;">Upload a photo or describe what you want to create</p>
                </div>
                
                <!-- How it works section -->
            <div style="text-align: center; margin: 0 auto 20px auto; padding: 16px 16px 20px 16px; width: 100%; max-width: 960px; background: var(--bg-stone); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); box-sizing: border-box; border: 1px solid rgba(43,43,43,0.08);">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div style="text-align: center;">
                        <div style="width: 40px; height: 40px; background: var(--oxblood); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0px auto 10px; color: var(--bg-parchment); font-weight: bold; font-size: 1em;">1</div>
                        <h4 style="color: var(--ink); font-weight: 700; margin-bottom: 5px; font-size: 0.95em;">Upload or Generate</h4>
                        <p style="color: rgba(43,43,43,0.8); font-size: 0.82em;">Choose your photo or describe what you want</p>
                    </div>
                    <div style="text-align: center;">
                        <div style="width: 40px; height: 40px; background: var(--oxblood); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0px auto 10px; color: var(--bg-parchment); font-weight: bold; font-size: 1em;">2</div>
                        <h4 style="color: var(--ink); font-weight: 700; margin-bottom: 5px; font-size: 0.95em;">Crop</h4>
                        <p style="color: rgba(43,43,43,0.8); font-size: 0.82em;">Crop your image to fit the shape of your pendant</p>
                    </div>
                    <div style="text-align: center;">
                        <div style="width: 40px; height: 40px; background: var(--oxblood); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0px auto 10px; color: var(--bg-parchment); font-weight: bold; font-size: 1em;">3</div>
                        <h4 style="color: var(--ink); font-weight: 700; margin-bottom: 5px; font-size: 0.95em;">Order</h4>
                        <p style="color: rgba(43,43,43,0.8); font-size: 0.82em;">Place your order and wait </p>
                    </div>
                </div>
            </div>
            
            <!-- FAQ Section (Process Panel) -->
            <div id="faq-container" style="text-align: center; margin: 0 auto 24px auto; padding: 18px 18px; width: 100%; max-width: 960px; background: var(--bg-stone); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); box-sizing: border-box; border: 1px solid rgba(43,43,43,0.08);">
                <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <h3 style="color: var(--ink); font-weight: 800; font-size: 1.6em; margin: 0;">FAQ</h3>
                    <button id="faq-toggle-all" aria-label="Toggle FAQ" style="display: inline-flex; align-items: center; justify-content: center; width: 34px; height: 34px; border-radius: 50%; border: 1px solid var(--ink); background: var(--bg-parchment); color: var(--ink); font-weight: 800; font-size: 1.1em; cursor: pointer; transition: all 0.2s ease; padding: 0;"></button>
                </div>
                <p id="faq-subtext" style="color: rgba(43,43,43,0.8); font-size: 0.95em; margin: 0 0 14px 0;">Answers to the most common questions.</p>
                <div id="faq-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <div style="background: var(--bg-parchment); border: 1px solid rgba(43,43,43,0.1); border-radius: 12px; overflow: hidden; text-align: left;">
                        <button class="faq-toggle" style="width: 100%; background: none; border: none; color: var(--ink); font-weight: 700; font-size: 1em; padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                            <span>What metals do you offer?</span>
                            <span aria-hidden="true">+</span>
                        </button>
                        <div class="faq-answer" style="display: none; padding: 0 16px 14px 16px; color: rgba(43,43,43,0.9); font-size: 0.95em; line-height: 1.5;">
                            We currently offer .925 sterling silver and 14k yellow gold. If you have a specific metal in mind, please contact us and we will do our best to accommodate your request.
                        </div>
                    </div>
                    <div style="background: var(--bg-parchment); border: 1px solid rgba(43,43,43,0.1); border-radius: 12px; overflow: hidden; text-align: left;">
                        <button class="faq-toggle" style="width: 100%; background: none; border: none; color: var(--ink); font-weight: 700; font-size: 1em; padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                            <span>How long will it take to receive my order?</span>
                            <span aria-hidden="true">+</span>
                        </button>
                        <div class="faq-answer" style="display: none; padding: 0 16px 14px 16px; color: rgba(43,43,43,0.9); font-size: 0.95em; line-height: 1.5;">
                            As each order is custom made-to-order, production time varies with average pieces shipping within 7 business days, with shipping times depending on your location. Youll receive tracking information once your package has shipped.
                        </div>
                    </div>
                    <div style="background: var(--bg-parchment); border: 1px solid rgba(43,43,43,0.1); border-radius: 12px; overflow: hidden; text-align: left;">
                        <button class="faq-toggle" style="width: 100%; background: none; border: none; color: var(--ink); font-weight: 700; font-size: 1em; padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                            <span>Can I preview the design before ordering?</span>
                            <span aria-hidden="true">+</span>
                        </button>
                        <div class="faq-answer" style="display: none; padding: 0 16px 14px 16px; color: rgba(43,43,43,0.9); font-size: 0.95em; line-height: 1.5;">
                            Yes. You can adjust and preview the 3D model in the studio before adding it to your cart.
                        </div>
                    </div>
                    <div style="background: var(--bg-parchment); border: 1px solid rgba(43,43,43,0.1); border-radius: 12px; overflow: hidden; text-align: left;">
                        <button class="faq-toggle" style="width: 100%; background: none; border: none; color: var(--ink); font-weight: 700; font-size: 1em; padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                            <span>What if my photo isnt perfect?</span>
                            <span aria-hidden="true">+</span>
                        </button>
                        <div class="faq-answer" style="display: none; padding: 0 16px 14px 16px; color: rgba(43,43,43,0.9); font-size: 0.95em; line-height: 1.5;">
                            We recommend clear, well-lit images. If we see issues, well reach out with suggestions before production.
                        </div>
                    </div>
                    <div style="background: var(--bg-parchment); border: 1px solid rgba(43,43,43,0.1); border-radius: 12px; overflow: hidden; text-align: left;">
                        <button class="faq-toggle" style="width: 100%; background: none; border: none; color: var(--ink); font-weight: 700; font-size: 1em; padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                            <span>What is your return policy?</span>
                            <span aria-hidden="true">+</span>
                        </button>
                        <div class="faq-answer" style="display: none; padding: 0 16px 14px 16px; color: rgba(43,43,43,0.9); font-size: 0.95em; line-height: 1.5;">
                            We accept returns on a case by case basis for items that do not meet your expectations. Please contact us within 72 hours of receiving your Image Keepsake and we will work with you to resolve the issue.
                        </div>
                    </div>
                    <div style="background: var(--bg-parchment); border: 1px solid rgba(43,43,43,0.1); border-radius: 12px; overflow: hidden; text-align: left;">
                        <button class="faq-toggle" style="width: 100%; background: none; border: none; color: var(--ink); font-weight: 700; font-size: 1em; padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                            <span>Do you offer design services?</span>
                            <span aria-hidden="true">+</span>
                        </button>
                        <div class="faq-answer" style="display: none; padding: 0 16px 14px 16px; color: rgba(43,43,43,0.9); font-size: 0.95em; line-height: 1.5;">
                            We do not formally offer design services, but we are happy to help you create a custom design for your Image Keepsake. Please contact us and we will work with you to create a custom design that makes you happy :).
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        </div>

        <!-- Testimonials Section (1/3 height) -->
        <div style="flex: 1; width: 100%; max-width: 100%; background: #f8f9fa; border-top: 2px solid #e2e8f0; padding: 20px; box-sizing: border-box; overflow: hidden;">
            <div style="text-align: center; margin-bottom: 20px; padding: 0 8px; box-sizing: border-box;">
                <h3 style="color: #2d3748; font-weight: 700; font-size: 1.8em; margin-bottom: 10px;">What Our Customers Say</h3>
                <p style="color: #718096; font-size: 1em;">Real experiences from happy customers</p>
            </div>
            
            <!-- Horizontal Scrolling Testimonials -->
            <div id="testimonials-container" style="display: flex; overflow-x: auto; gap: 16px; padding: 10px 20px 10px 12px; margin: 0 auto; width: 100%; max-width: 100%; box-sizing: border-box; scroll-behavior: smooth; -webkit-overflow-scrolling: touch;">
                <!-- Testimonial 1 -->
                <div style="min-width: 280px; flex: 0 0 280px; background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; flex-shrink: 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="width: 50px; height: 50px; background: #1d4ed8; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2em; margin-right: 15px;">S</div>
                        <div>
                            <h4 style="color: #2d3748; font-weight: 600; margin: 0; font-size: 1.1em;">Sarah M.</h4>
                            <div style="color: #fbbf24; font-size: 1.1em;"></div>
                        </div>
                    </div>
                    <p style="color: #4a5568; line-height: 1.6; margin: 0; font-style: italic;">"Absolutely stunning! The pendant turned out even better than I imagined. The quality is incredible and it arrived so quickly!"</p>
                </div>

                <!-- Testimonial 2 -->
                <div style="min-width: 280px; flex: 0 0 280px; background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; flex-shrink: 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="width: 50px; height: 50px; background: #1d4ed8; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2em; margin-right: 15px;">M</div>
                        <div>
                            <h4 style="color: #2d3748; font-weight: 600; margin: 0; font-size: 1.1em;">Mike R.</h4>
                            <div style="color: #fbbf24; font-size: 1.1em;"></div>
                        </div>
                    </div>
                    <p style="color: #4a5568; line-height: 1.6; margin: 0; font-style: italic;">"The AI generation feature is mind-blowing! I described what I wanted and it created the perfect design. Highly recommend!"</p>
                </div>

                <!-- Testimonial 3 -->
                <div style="min-width: 280px; flex: 0 0 280px; background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; flex-shrink: 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="width: 50px; height: 50px; background: #1d4ed8; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2em; margin-right: 15px;">J</div>
                        <div>
                            <h4 style="color: #2d3748; font-weight: 600; margin: 0; font-size: 1.1em;">Jennifer L.</h4>
                            <div style="color: #fbbf24; font-size: 1.1em;"></div>
                        </div>
                    </div>
                    <p style="color: #4a5568; line-height: 1.6; margin: 0; font-style: italic;">"Perfect gift for my mom's birthday. The customization options are amazing and the final product is beautiful quality."</p>
                </div>

                <!-- Testimonial 4 -->
                <div style="min-width: 300px; background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; flex-shrink: 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="width: 50px; height: 50px; background: #1d4ed8; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2em; margin-right: 15px;">D</div>
                        <div>
                            <h4 style="color: #2d3748; font-weight: 600; margin: 0; font-size: 1.1em;">David K.</h4>
                            <div style="color: #fbbf24; font-size: 1.1em;"></div>
                        </div>
                    </div>
                    <p style="color: #4a5568; line-height: 1.6; margin: 0; font-style: italic;">"Incredible attention to detail. The 3D preview helped me see exactly what I was getting. Will definitely order again!"</p>
                </div>

                <!-- Testimonial 5 -->
                <div style="min-width: 300px; background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; flex-shrink: 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="width: 50px; height: 50px; background: #e53e3e; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2em; margin-right: 15px;">E</div>
                        <div>
                            <h4 style="color: #2d3748; font-weight: 600; margin: 0; font-size: 1.1em;">Emma T.</h4>
                            <div style="color: #fbbf24; font-size: 1.1em;"></div>
                        </div>
                    </div>
                    <p style="color: #4a5568; line-height: 1.6; margin: 0; font-style: italic;">"The process was so easy and fun! I love how I could see my design come to life in 3D before ordering."</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:3000;justify-content:center;align-items:center;flex-direction:column;">
    <div style="text-align:center;color:white;">
        <div style="margin-bottom:30px;">
            <svg width="60" height="60" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" stroke="#fff" stroke-width="8" fill="none" opacity="0.2"/>
                <circle id="loading-spinner" cx="50" cy="50" r="40" stroke="#4af" stroke-width="8" fill="none" stroke-dasharray="251.2" stroke-dashoffset="0">
                    <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="1s" repeatCount="indefinite"/>
                </circle>
            </svg>
        </div>
        <div id="loading-status" style="font-size:1.3em;margin-bottom:18px;">Analyzing image...</div>
        <div style="width:300px;background:#222;border-radius:8px;overflow:hidden;margin:0 auto;">
            <div id="loading-progress-bar" style="height:18px;width:0%;background:#4af;transition:width 0.3s;"></div>
        </div>
    </div>
</div>

    <!-- Mobile Menu Toggle Button -->
    <button id="mobile-menu-toggle" aria-label="Toggle Menu">
        
    </button>


    <!-- Notification system -->
    <div id="notification" style="display:none;position:fixed;top:20px;right:20px;background:#4CAF50;color:white;padding:15px 20px;border-radius:5px;z-index:3000;max-width:400px;box-shadow:0 4px 8px rgba(0,0,0,0.2);">
        <div id="notification-content"></div>
        <button id="notification-close" style="background:none;border:none;color:white;float:right;font-size:18px;cursor:pointer;margin-left:10px;">&times;</button>
    </div>

    <!-- AI Prompt Modal -->
    <div id="ai-prompt-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:5000;backdrop-filter:blur(5px);">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,0.3);max-width:500px;width:90%;">
            <div style="text-align:center;margin-bottom:20px;">
                <h2 style="margin:0;color:#333;font-size:24px;"> Imagine with AI</h2>
                <p style="margin:10px 0 0 0;color:#666;font-size:16px;">Describe your dream pendant and we'll create it for you</p>
            </div>
            
            <div style="margin-bottom:20px;">
                <textarea id="ai-prompt-input-modal" placeholder="Describe what you want to create... (e.g., 'a majestic golden eagle in flight', 'abstract geometric patterns', 'a beautiful rose garden')" rows="4" style="width:100%;padding:15px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px;resize:vertical;box-sizing:border-box;"></textarea>
            </div>
            
            <div style="display:flex;gap:10px;justify-content:center;">
                <button id="generate-ai-btn-modal" style="background:#1d4ed8;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s ease;">
                    <span style="margin-right:8px;"></span>Generate
                </button>
                <button id="cancel-ai-btn-modal" style="background:#f5f5f5;color:#666;border:2px solid #e0e0e0;padding:12px 24px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s ease;">
                    Cancel
                </button>
            </div>
        </div>
    </div>






        <!-- Enhanced Lighting Controls for Shine Showcase -->
        <div class="menu-section" style="display: none;">
            <div class="menu-header">
                <h3> Lighting & Shine</h3>
                <button class="toggle-button"></button>
            </div>
            <div class="menu-content active">
                <div class="control-group">
                    <label for="ambient-intensity">Ambient Light</label>
                    <input type="range" id="ambient-intensity" min="0" max="1" step="0.01" value="0.3">
                    <span class="slider-value" id="ambient-intensity-value">0.3</span>
                </div>
                <div class="control-group">
                    <label for="directional-intensity">Key Light (Main)</label>
                    <input type="range" id="directional-intensity" min="0" max="2" step="0.01" value="1.2">
                    <span class="slider-value" id="directional-intensity-value">1.2</span>
                </div>
                <div class="control-group">
                    <label for="fill-light-intensity">Fill Light</label>
                    <input type="range" id="fill-light-intensity" min="0" max="1.5" step="0.01" value="0.6">
                    <span class="slider-value" id="fill-light-intensity-value">0.6</span>
                </div>
                <div class="control-group">
                    <label for="rim-light-intensity">Rim Light (Edge Glow)</label>
                    <input type="range" id="rim-light-intensity" min="0" max="1.5" step="0.01" value="0.8">
                    <span class="slider-value" id="rim-light-intensity-value">0.8</span>
                </div>
                <div class="control-group">
                    <label for="accent-light-intensity">Accent Lights (Sparkle)</label>
                    <input type="range" id="accent-light-intensity" min="0" max="1" step="0.01" value="0.5">
                    <span class="slider-value" id="accent-light-intensity-value">0.5</span>
                </div>
                <div class="control-group">
                    <label for="env-map-intensity">Environment Reflections</label>
                    <input type="range" id="env-map-intensity" min="0" max="3" step="0.01" value="1.5">
                    <span class="slider-value" id="env-map-intensity-value">1.5</span>
                </div>
            </div>
        </div>


    </div>

    <!-- Cropper Modal -->
    <div id="cropper-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:4000;justify-content:center;align-items:center;flex-direction:column;">
        <div style="background:#222;padding:24px;border-radius:10px;box-shadow:0 2px 16px #000;max-width:90vw;max-height:90vh;display:flex;flex-direction:row;align-items:flex-start;gap:32px;">
            <!-- Mobile cropping instructions -->
            <div id="mobile-crop-instructions" style="display:none;position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,150,0,0.9);color:white;padding:8px 16px;border-radius:6px;font-size:14px;z-index:1;text-align:center;">
                 Drag corners to crop  Double-tap to reset
            </div>
            <div style="display:flex;flex-direction:column;align-items:center;">
                <img id="cropper-image" src="" style="max-width:70vw;max-height:60vh;display:block;background:#111;"/>
                <!-- Cropper Toolbar -->
                <div id="cropper-toolbar" style="margin-top:18px;display:flex;gap:10px;align-items:center;">
                    <label style="color:white;">Aspect:</label>
                    <select id="cropper-aspect" style="padding:2px 6px;">
                        <option value="free">Free</option>
                        <option value="1">1:1</option>
                        <option value="4/3">4:3</option>
                        <option value="16/9">16:9</option>
                    </select>
                    <button id="cropper-rotate-left" title="Rotate Left"></button>
                    <button id="cropper-rotate-right" title="Rotate Right"></button>
                    <button id="cropper-flip-h" title="Flip Horizontal"></button>
                    <button id="cropper-flip-v" title="Flip Vertical"></button>
                    <button id="cropper-zoom-in" title="Zoom In"></button>
                    <button id="cropper-zoom-out" title="Zoom Out"></button>
                    <button id="cropper-reset" title="Reset">Reset</button>
                    <button id="cropper-fit" title="Fit crop box to image">Fit</button>
                    <button id="cropper-center" title="Center crop box">Center</button>
                </div>
                <!-- Pixel-precise controls -->
                <div id="cropper-pixel-controls" style="margin-top:10px;display:flex;gap:8px;align-items:center;">
                    <label style="color:white;font-size:0.95em;">X: <input id="cropper-x" type="number" style="width:60px;"></label>
                    <label style="color:white;font-size:0.95em;">Y: <input id="cropper-y" type="number" style="width:60px;"></label>
                    <label style="color:white;font-size:0.95em;">W: <input id="cropper-w" type="number" style="width:60px;"></label>
                    <label style="color:white;font-size:0.95em;">H: <input id="cropper-h" type="number" style="width:60px;"></label>
                    <span style="color:#aaa;font-size:0.95em;">Zoom: <span id="cropper-zoom">100%</span></span>
                    <span style="color:#aaa;font-size:0.95em;">Rot: <span id="cropper-rotation">0</span></span>
                </div>
                <div class="action-buttons" style="margin-top:18px;display:flex;gap:16px;justify-content:center;">
                    <button id="cropper-confirm" style="padding:8px 24px;font-size:1.1em;">Crop & Continue</button>
                    <button id="cropper-cancel" style="padding:8px 24px;font-size:1.1em;">Cancel</button>
                </div>
                
                <!-- 2D Laser Etch Controls (hidden by default) -->
                <div id="laser-etch-controls" style="display: none; margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.1); border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: white;">Laser Etch Optimization</h4>
                    <div class="control-group">
                        <label for="contrast-slider" style="color: white;">Contrast Adjustment:</label>
                        <input type="range" id="contrast-slider" min="0" max="200" value="100" step="1" style="width: 200px;">
                        <span class="slider-value" id="contrast-value" style="color: white;">100%</span>
                    </div>
                    <div class="control-group">
                        <button id="auto-contrast-btn" class="auto-contrast-button" style="background: #1d4ed8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Auto Optimize for Laser</button>
                    </div>
                    <div class="control-group">
                        <label style="font-size: 12px; color: #ccc;">For best results, use an evenly and well-lit image. See the reference images for examples.</label>
                    </div>
                </div>
            </div>
            <!-- Live Preview -->
            <div id="cropper-preview-container" style="background:#111;padding:12px;border-radius:8px;min-width:260px;min-height:260px;display:flex;flex-direction:column;align-items:center;">
                <div style="color:white;font-size:1em;margin-bottom:8px;">Live Preview</div>
                <div style="background:#222;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center;width:250px;height:250px;">
                    <canvas id="cropper-preview" width="250" height="250" style="display:block;"></canvas>
                </div>
            </div>
                
            </div>
    </div>

    <!-- Mobile Debug Panel -->
    <div id="mobile-debug" style="display:none;position:fixed;top:10px;left:10px;background:rgba(255,0,0,0.9);color:white;padding:10px;border-radius:6px;font-size:12px;z-index:5001;max-width:300px;word-wrap:break-word;">
        <div style="font-weight:bold;margin-bottom:5px;">Mobile Debug Info:</div>
        <div id="debug-content"></div>
    </div>

    <!-- Deployment GUID Display -->
<div id="deployment-guid" style="display:none;position:fixed;bottom:12px;left:12px;background:rgba(0,0,0,0.7);color:#fff;padding:6px 14px;border-radius:6px;font-size:0.95em;z-index:5000;pointer-events:none;user-select:text;">Loading version...</div>

    <script type="module" src="./src/main.js?v=4&t=1234567890"></script>
    <!-- Cropper.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <!-- dat.GUI Initialization Script -->
    <script>
        // Wait for the page to load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOMContentLoaded fired ===');
            
            // Test OpenAI functions availability
            setTimeout(() => {
                console.log(' Testing OpenAI functions after 1 second...');
                console.log('window.generateImageWithOpenAI:', typeof window.generateImageWithOpenAI);
                console.log('window.uploadDalleImageToS3:', typeof window.uploadDalleImageToS3);
                console.log('window.viewer:', !!window.viewer);
                if (window.viewer) {
                    console.log('window.viewer.generateImageWithOpenAI:', typeof window.viewer.generateImageWithOpenAI);
                    console.log('window.viewer.uploadDalleImageToS3:', typeof window.viewer.uploadDalleImageToS3);
                } else {
                    console.log(' window.viewer is not available');
                }
                console.log('All window functions:', Object.keys(window).filter(key => key.includes('generate') || key.includes('upload') || key.includes('openai')));
                
                // Check if module script loaded
                const moduleScript = document.querySelector('script[src*="main.js"]');
                console.log(' Module script element:', moduleScript);
                
                // Try again after more time
                setTimeout(() => {
                    console.log(' Testing again after 5 seconds total...');
                    console.log('window.viewer:', !!window.viewer);
                    if (!window.viewer) {
                        console.log(' Viewer still not available after 5 seconds - module may have failed to load');
                    }
                }, 4000);
            }, 1000);
            
            // Mobile Shopify-style interactions
            initializeMobileInteractions();
            
            // Force initial layout visibility
            setTimeout(() => {
                forceLayoutVisibility();
            }, 100);
            
            // Monitor for image processing completion
            monitorImageProcessing();
            
            // Handle mobile orientation changes
            handleOrientationChange();
            
            // Initialize dat.GUI
            const gui = new dat.GUI({ autoPlace: false });
            
            // Move dat.GUI to our container
            const container = document.getElementById('dat-gui-container');
            if (container) {
                container.appendChild(gui.domElement);
            }
            
            // Create control object to mirror the existing controls
            const controls = {
                // Object Type Controls
                designMethod: '3d-design',
                objectType: 'circular-pendant',
                
                // Metal Settings
                metalType: 'sterling-silver',
                metalFinish: 'polished',
                antiquingAmount: 0.5,
                
                // Text Box Controls
                addTextBox: function() {
                    // Trigger the add text box button
                    const addButton = document.getElementById('add-text-box');
                    if (addButton) addButton.click();
                },
                
                // Camera Controls
                resetView: function() {
                    const resetButton = document.getElementById('reset-view');
                    if (resetButton) resetButton.click();
                },
                
                screenshot: function() {
                    const screenshotButton = document.getElementById('screenshot');
                    if (screenshotButton) screenshotButton.click();
                },
                
                submitOrder: function() {
                    const submitButton = document.getElementById('export-stl');
                    if (submitButton) submitButton.click();
                }
            };
            
            // Create folders for organization
            const objectFolder = gui.addFolder('Object Type');
            objectFolder.add(controls, 'designMethod', ['3d-design', '2d-laser-etch']).name('Design Method').onChange(function(value) {
                const select = document.getElementById('design-method');
                if (select) {
                    select.value = value;
                    select.dispatchEvent(new Event('change'));
                }
            });
            
            objectFolder.add(controls, 'objectType', ['circular-pendant', 'earrings']).name('Object Type').onChange(function(value) {
                const select = document.getElementById('object-type');
                if (select) {
                    select.value = value;
                    select.dispatchEvent(new Event('change'));
                }
            });
            
            const metalFolder = gui.addFolder('Metal Settings');
            metalFolder.add(controls, 'metalType', ['sterling-silver', 'gold-14k']).name('Metal Type').onChange(function(value) {
                const select = document.getElementById('metal-type');
                if (select) {
                    select.value = value;
                    select.dispatchEvent(new Event('change'));
                }
            });
            
            metalFolder.add(controls, 'metalFinish', ['polished', 'brushed', 'matte']).name('Metal Finish').onChange(function(value) {
                const select = document.getElementById('metal-finish');
                if (select) {
                    select.value = value;
                    select.dispatchEvent(new Event('change'));
                }
            });
            
            metalFolder.add(controls, 'antiquingAmount', 0, 1, 0.01).name('Antiquing Amount').onChange(function(value) {
                const slider = document.getElementById('antiquing-amount');
                if (slider) {
                    slider.value = value;
                    slider.dispatchEvent(new Event('input'));
                }
            });
            
            const textFolder = gui.addFolder('Text Boxes');
            textFolder.add(controls, 'addTextBox').name('Add Text Box');
            
            const actionsFolder = gui.addFolder('Actions');
            actionsFolder.add(controls, 'resetView').name('Reset View');
            actionsFolder.add(controls, 'screenshot').name('Screenshot');
            actionsFolder.add(controls, 'submitOrder').name('Submit Order');
            
            // Open all folders by default
            objectFolder.open();
            metalFolder.open();
            textFolder.open();
            actionsFolder.open();
            
            // Sync dat.GUI with existing controls
            function syncWithExistingControls() {
                // Sync design method
                const designMethodSelect = document.getElementById('design-method');
                if (designMethodSelect) {
                    controls.designMethod = designMethodSelect.value;
                }
                
                // Sync object type
                const objectTypeSelect = document.getElementById('object-type');
                if (objectTypeSelect) {
                    controls.objectType = objectTypeSelect.value;
                }
                
                // Sync metal type
                const metalTypeSelect = document.getElementById('metal-type');
                if (metalTypeSelect) {
                    controls.metalType = metalTypeSelect.value;
                }
                
                // Sync metal finish
                const metalFinishSelect = document.getElementById('metal-finish');
                if (metalFinishSelect) {
                    controls.metalFinish = metalFinishSelect.value;
                }
                
                // Sync antiquing amount
                const antiquingSlider = document.getElementById('antiquing-amount');
                if (antiquingSlider) {
                    controls.antiquingAmount = parseFloat(antiquingSlider.value);
                }
            }
            
            // Sync on page load
            setTimeout(syncWithExistingControls, 1000);
            
            // Listen for changes in the existing controls
            document.addEventListener('change', function(e) {
                if (e.target.id === 'design-method') {
                    controls.designMethod = e.target.value;
                } else if (e.target.id === 'object-type') {
                    controls.objectType = e.target.value;
                } else if (e.target.id === 'metal-type') {
                    controls.metalType = e.target.value;
                } else if (e.target.id === 'metal-finish') {
                    controls.metalFinish = e.target.value;
                }
            });
            
            document.addEventListener('input', function(e) {
                if (e.target.id === 'antiquing-amount') {
                    controls.antiquingAmount = parseFloat(e.target.value);
                }
            });
        });
        
        // Mobile Shopify-style interactions
        function initializeMobileInteractions() {
            console.log('=== initializeMobileInteractions called ===');
            
            // Initialize responsive layout handling
            handleResponsiveLayout();
            
            // Handle window resize for responsive layout
            window.addEventListener('resize', function() {
                console.log('Window resized to:', window.innerWidth, 'x', window.innerHeight);
                handleResponsiveLayout();
                
                // Update renderer size for new layout
                setTimeout(() => {
                    updateRendererForCurrentLayout();
                }, 100);
            });
            
            // Handle orientation change
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    handleResponsiveLayout();
                    updateRendererForCurrentLayout();
                }, 300);
            });
            
            // Initialize UI interactions
            console.log('About to initialize UI interactions...');
            initializeOptionInteractions();
            initializePhotoButton();
            initializeImagineButton();
            
            // Check for canvas and Three.js setup
            const checkForCanvas = setInterval(function() {
                const canvas = document.querySelector('canvas');
                if (canvas && window.viewer) {
                    clearInterval(checkForCanvas);
                    console.log('Canvas and viewer found, initializing layout');
                    updateRendererForCurrentLayout();
                }
            }, 100);
        }
        
        // Handle view changes in carousel
        function handleViewChange(viewType) {
            console.log('Switching to view:', viewType);
            // Here you can implement different view logic
            // For now, we'll just log the change
            switch(viewType) {
                case '3d':
                    // Show 3D viewer
                    break;
                case 'front':
                    // Show front view image
                    if (imageViewerContainer && mainImageViewer) {
                        mainImageViewer.src = '/retrieverModel.png';
                        imageViewerContainer.style.display = 'block';
                    }
                    break;
                case 'side':
                    // Show side view image
                    if (imageViewerContainer && mainImageViewer) {
                        mainImageViewer.src = '/instructions.png';
                        imageViewerContainer.style.display = 'block';
                    }
                    break;
                case 'retriever-metal':
                    // Show retriever metal image
                    if (imageViewerContainer && mainImageViewer) {
                        mainImageViewer.src = '/retrieverMetal.png';
                        imageViewerContainer.style.display = 'block';
                    }
                    break;
                case 'sailing':
                    // Show sailing scene image
                    if (imageViewerContainer && mainImageViewer) {
                        mainImageViewer.src = '/sailingSceneProductPhoto.png';
                        imageViewerContainer.style.display = 'block';
                    }
                    break;
                case 'before':
                    // Show before image
                    if (imageViewerContainer && mainImageViewer) {
                        mainImageViewer.src = '/before.png';
                        imageViewerContainer.style.display = 'block';
                    }
                    break;
                case 'jewelry':
                    // Show jewelry image
                    if (imageViewerContainer && mainImageViewer) {
                        mainImageViewer.src = '/foreverAndEverJewelry.png';
                        imageViewerContainer.style.display = 'block';
                    }
                    break;
            }
        }
        
        // Update metal type
        function updateMetalType(metalType) {
            console.log('Updating metal type to:', metalType);
            // Update the 3D model material
            // This would integrate with your existing 3D rendering logic
        }
        
        // Move 3D canvas between desktop and mobile containers
        function moveCanvasToMobileContainer() {
            const canvas = document.querySelector('canvas');
            const mobileContainer = document.getElementById('mobile-canvas-container');
            const desktopContainer = document.getElementById('canvas-container');
            
            if (!canvas || !mobileContainer || !desktopContainer) {
                console.log('Canvas or containers not found, waiting for 3D scene to load...');
                return;
            }
            
            // Check if we're on mobile (width <= 768px)
            const isMobile = window.innerWidth <= 768;
            console.log('Window width:', window.innerWidth, 'Is mobile:', isMobile);
            console.log('Exact boundary check - width === 768:', window.innerWidth === 768);
            console.log('Exact boundary check - width === 767:', window.innerWidth === 767);
            
            // Force mobile layout visibility if on mobile
            if (isMobile) {
                const mobileLayout = document.querySelector('.mobile-shopify-layout');
                const desktopLayout = document.querySelector('.desktop-layout');
                
                if (mobileLayout) {
                    mobileLayout.style.display = 'flex !important';
                    mobileLayout.style.visibility = 'visible !important';
                    mobileLayout.style.opacity = '1 !important';
                    mobileLayout.style.position = 'relative !important';
                    mobileLayout.style.zIndex = '1000 !important';
                    console.log('Forced mobile layout to display: flex');
                }
                
                if (desktopLayout) {
                    desktopLayout.style.display = 'none !important';
                    desktopLayout.style.visibility = 'hidden !important';
                    desktopLayout.style.opacity = '0 !important';
                    desktopLayout.style.position = 'absolute !important';
                    desktopLayout.style.zIndex = '-1 !important';
                    console.log('Forced desktop layout to display: none');
                }
                
                // Also hide all conflicting elements
                const conflictingElements = [
                    '#ui-menu',
                    '#drop-zone',
                    '#reference-image-container',
                    '.ui-menu-panel',
                    '#dat-gui-container'
                ];
                
                conflictingElements.forEach(selector => {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.style.display = 'none !important';
                        element.style.visibility = 'hidden !important';
                        element.style.opacity = '0 !important';
                        console.log('Hidden conflicting element:', selector);
                    }
                });
            }
            
            if (isMobile) {
                // Move canvas to mobile container
                if (canvas.parentElement !== mobileContainer) {
                    console.log('Moving canvas to mobile container');
                    mobileContainer.appendChild(canvas);
                    // Ensure canvas fills the mobile container
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    canvas.style.display = 'block';
                    
                    // Update renderer size for mobile container
                    setTimeout(() => {
                        updateRendererSize(mobileContainer);
                    }, 100);
                }
            } else {
                // Move canvas back to desktop container
                if (canvas.parentElement !== desktopContainer) {
                    console.log('Moving canvas to desktop container');
                    desktopContainer.appendChild(canvas);
                    // Reset canvas styling for desktop
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    canvas.style.display = 'block';
                    
                    // Update renderer size for desktop container
                    setTimeout(() => {
                        updateRendererSize(desktopContainer);
                    }, 100);
                }
            }
        }
        
        // Debug canvas state
        function debugCanvasState() {
            const canvas = document.querySelector('canvas');
            const mobileContainer = document.getElementById('mobile-canvas-container');
            const desktopContainer = document.getElementById('canvas-container');
            
            console.log('=== Canvas Debug Info ===');
            console.log('Canvas exists:', !!canvas);
            if (canvas) {
                console.log('Canvas parent:', canvas.parentElement.id);
                console.log('Canvas dimensions:', canvas.width, 'x', canvas.height);
                console.log('Canvas style dimensions:', canvas.style.width, 'x', canvas.style.height);
                console.log('Canvas display:', canvas.style.display);
            }
            console.log('Mobile container exists:', !!mobileContainer);
            if (mobileContainer) {
                console.log('Mobile container dimensions:', mobileContainer.clientWidth, 'x', mobileContainer.clientHeight);
            }
            console.log('Desktop container exists:', !!desktopContainer);
            if (desktopContainer) {
                console.log('Desktop container dimensions:', desktopContainer.clientWidth, 'x', desktopContainer.clientHeight);
            }
            console.log('Window viewer exists:', !!window.viewer);
            if (window.viewer) {
                console.log('Viewer renderer exists:', !!window.viewer.renderer);
                console.log('Viewer camera exists:', !!window.viewer.camera);
            }
            console.log('Is mobile:', window.innerWidth <= 768);
            
            // Check mobile layout visibility
            const mobileLayout = document.querySelector('.mobile-shopify-layout');
            const desktopLayout = document.querySelector('.desktop-layout');
            console.log('Mobile layout display:', mobileLayout ? getComputedStyle(mobileLayout).display : 'not found');
            console.log('Desktop layout display:', desktopLayout ? getComputedStyle(desktopLayout).display : 'not found');
            
            console.log('========================');
        }
        
        // EMERGENCY DEBUG FUNCTION - Call this from console
        window.debugCanvasIssue = function() {
            console.log(' DEBUGGING CANVAS COVERAGE ISSUE');
            console.log('=====================================');
            
            const canvas = document.querySelector('canvas');
            if (!canvas) {
                console.log(' NO CANVAS FOUND!');
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            const style = getComputedStyle(canvas);
            
            console.log(' CANVAS INFO:');
            console.log('- Element:', canvas);
            console.log('- Parent:', canvas.parentElement);
            console.log('- Width (attr):', canvas.width);
            console.log('- Height (attr):', canvas.height);
            console.log('- Width (style):', style.width);
            console.log('- Height (style):', style.height);
            console.log('- Width (computed):', rect.width);
            console.log('- Height (computed):', rect.height);
            console.log('- Display:', style.display);
            console.log('- Visibility:', style.visibility);
            console.log('- Opacity:', style.opacity);
            console.log('- Z-Index:', style.zIndex);
            console.log('- Position:', rect.left, rect.top);
            console.log('- IS VISIBLE:', rect.width > 0 && rect.height > 0);
            
            console.log('\n PARENT CHAIN:');
            let parent = canvas.parentElement;
            let level = 1;
            while (parent && level <= 3) {
                const pRect = parent.getBoundingClientRect();
                const pStyle = getComputedStyle(parent);
                console.log(`Level ${level}: ${parent.tagName}${parent.id ? '#' + parent.id : ''}`);
                console.log('  - Size:', pRect.width + 'x' + pRect.height);
                console.log('  - Display:', pStyle.display);
                console.log('  - Background:', pStyle.backgroundColor);
                parent = parent.parentElement;
                level++;
            }
            
            console.log('\n COVERING ELEMENTS:');
            const allElements = document.querySelectorAll('*');
            const covering = [];
            
            allElements.forEach(el => {
                if (el === canvas) return;
                const eRect = el.getBoundingClientRect();
                const eStyle = getComputedStyle(el);
                const zIndex = parseInt(eStyle.zIndex) || 0;
                
                if (eRect.width > 0 && eRect.height > 0 && 
                    eStyle.display !== 'none' && 
                    eStyle.visibility !== 'hidden') {
                    
                    const overlaps = !(eRect.right < rect.left || 
                                     eRect.left > rect.right || 
                                     eRect.bottom < rect.top || 
                                     eRect.top > rect.bottom);
                    
                    if (overlaps) {
                        covering.push({
                            element: el,
                            tag: el.tagName + (el.id ? '#' + el.id : '') + (el.className ? '.' + el.className.split(' ')[0] : ''),
                            zIndex: zIndex,
                            isHigher: zIndex > parseInt(style.zIndex || 0)
                        });
                    }
                }
            });
            
            covering.sort((a, b) => b.zIndex - a.zIndex);
            covering.slice(0, 10).forEach((item, i) => {
                console.log(`${i + 1}. ${item.tag} (z-index: ${item.zIndex}) ${item.isHigher ? ' HIGHER' : ''}`);
                if (i < 3) console.log('   Element:', item.element);
            });
            
            console.log('\n TO FIX: If canvas has 0x0 dimensions, that\'s the problem!');
            console.log(' TO FIX: If elements have higher z-index, that\'s the problem!');
            console.log('=====================================');
            
            // Try to fix common issues
            if (rect.width === 0 || rect.height === 0) {
                console.log(' ATTEMPTING AUTO-FIX: Canvas has zero dimensions');
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                if (window.viewer && window.viewer.renderer) {
                    const container = canvas.parentElement;
                    const w = Math.max(container.clientWidth, 300);
                    const h = Math.max(container.clientHeight, 300);
                    window.viewer.renderer.setSize(w, h);
                    console.log(' Renderer resized to:', w, 'x', h);
                }
            }
        };
        
        // Monitor for image processing completion and ensure canvas visibility
        function monitorImageProcessing() {
            // Check every 500ms for changes that might affect canvas visibility
            setInterval(() => {
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    // Debug: Check what's covering the canvas
                    debugCanvasCoverage();
                    
                    // Force canvas visibility on mobile
                    const canvas = document.querySelector('canvas');
                    if (canvas) {
                        canvas.style.display = 'block !important';
                        canvas.style.visibility = 'visible !important';
                        canvas.style.opacity = '1 !important';
                        canvas.style.zIndex = '1 !important';
                    }
                    
                    // Ensure mobile layout is visible
                    const mobileLayout = document.querySelector('.mobile-shopify-layout');
                    if (mobileLayout) {
                        mobileLayout.style.display = 'flex !important';
                        mobileLayout.style.visibility = 'visible !important';
                        mobileLayout.style.opacity = '1 !important';
                        mobileLayout.style.zIndex = '1000 !important';
                    }
                    
                    // Keep desktop layout hidden
                    const desktopLayout = document.querySelector('.desktop-layout');
                    if (desktopLayout) {
                        desktopLayout.style.display = 'none !important';
                        desktopLayout.style.visibility = 'hidden !important';
                        desktopLayout.style.opacity = '0 !important';
                        desktopLayout.style.zIndex = '-1 !important';
                    }
                    
                    // Keep UI menu available but positioned appropriately
                    const uiMenu = document.getElementById('ui-menu');
                    if (uiMenu) {
                        // Don't hide completely - just position it properly
                        uiMenu.style.display = 'block';
                        uiMenu.style.visibility = 'visible';
                        uiMenu.style.opacity = '1';
                        uiMenu.style.zIndex = '1000';
                    }
                }
            }, 500);
        }
        
        // Handle mobile resize events to keep Three.js renderer properly sized
        function handleMobileResize() {
            const isMobile = window.innerWidth <= 768;
            console.log('Handling resize - isMobile:', isMobile);
            
            if (isMobile) {
                const canvas = document.querySelector('canvas');
                const mobileContainer = document.getElementById('mobile-canvas-container');
                
                if (canvas && mobileContainer && window.viewer && window.viewer.renderer) {
                    // Get current container dimensions
                    const containerWidth = mobileContainer.clientWidth;
                    const containerHeight = mobileContainer.clientHeight;
                    
                    console.log('Mobile container dimensions after resize:', containerWidth, 'x', containerHeight);
                    
                    // Ensure minimum dimensions
                    const finalWidth = Math.max(containerWidth, 300);
                    const finalHeight = Math.max(containerHeight, 300);
                    
                    // Update renderer size
                    window.viewer.renderer.setSize(finalWidth, finalHeight);
                    
                    // Update camera aspect ratio
                    window.viewer.camera.aspect = finalWidth / finalHeight;
                    window.viewer.camera.updateProjectionMatrix();
                    
                    // Force canvas styling
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    canvas.style.display = 'block';
                    canvas.style.visibility = 'visible';
                    canvas.style.opacity = '1';
                    
                    // Force a render
                    window.viewer.renderer.render(window.viewer.scene, window.viewer.camera);
                    
                    console.log('Mobile renderer resized to:', finalWidth, 'x', finalHeight);
                    console.log('Canvas after resize:', {
                        width: canvas.width,
                        height: canvas.height,
                        styleWidth: canvas.style.width,
                        styleHeight: canvas.style.height
                    });
                } else {
                    console.warn('Missing elements for mobile resize:', {
                        canvas: !!canvas,
                        mobileContainer: !!mobileContainer,
                        viewer: !!window.viewer,
                        renderer: !!(window.viewer && window.viewer.renderer)
                    });
                }
            }
        }
        
        // Handle mobile orientation changes
        function handleOrientationChange() {
            // Listen for orientation change events
            window.addEventListener('orientationchange', function() {
                console.log('Orientation changed');
                setTimeout(() => {
                    handleMobileResize();
                    // Run debug to check state after orientation change
                    if (window.debugCanvasIssue) {
                        console.log('Running post-orientation debug...');
                        window.debugCanvasIssue();
                    }
                }, 500); // Wait for orientation change to complete
            });
            
            // Also listen for screen orientation API if available
            if (screen && screen.orientation) {
                screen.orientation.addEventListener('change', function() {
                    console.log('Screen orientation changed to:', screen.orientation.angle);
                    setTimeout(() => {
                        handleMobileResize();
                    }, 300);
                });
            }
        }
        
        // Continuous canvas monitoring to ensure it stays in mobile container
        function startCanvasMonitoring() {
            setInterval(() => {
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    const canvas = document.querySelector('canvas');
                    const mobileContainer = document.getElementById('mobile-canvas-container');
                    const desktopContainer = document.getElementById('canvas-container');
                    
                    if (canvas && mobileContainer && desktopContainer) {
                        // Check if canvas is in the wrong container
                        if (canvas.parentElement === desktopContainer) {
                            console.log('Canvas moved to desktop container, moving back to mobile');
                            moveCanvasToMobileContainer();
                        }
                        
                        // Ensure canvas is properly sized and visible
                        canvas.style.width = '100% !important';
                        canvas.style.height = '100% !important';
                        canvas.style.display = 'block !important';
                        canvas.style.visibility = 'visible !important';
                        canvas.style.opacity = '1 !important';
                        canvas.style.zIndex = '1 !important';
                    }
                }
            }, 1000);
        }
        
        // Debug function to check what's covering the canvas
        function debugCanvasCoverage() {
            const canvas = document.querySelector('canvas');
            if (!canvas) {
                console.log('No canvas found');
                return;
            }
            
            const rect = canvas.getBoundingClientRect();
            console.log('Canvas position:', rect);
            console.log('Canvas visible:', rect.width > 0 && rect.height > 0);
            
            // Check all elements that might be covering the canvas
            const coveringElements = [];
            
            // Check for loading overlay
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                const overlayRect = loadingOverlay.getBoundingClientRect();
                const overlayStyle = getComputedStyle(loadingOverlay);
                console.log('Loading overlay:', {
                    display: overlayStyle.display,
                    visibility: overlayStyle.visibility,
                    opacity: overlayStyle.opacity,
                    zIndex: overlayStyle.zIndex,
                    rect: overlayRect
                });
                if (overlayStyle.display !== 'none') {
                    coveringElements.push('loading-overlay');
                }
            }
            
            // Check for any elements with high z-index that might be covering
            const allElements = document.querySelectorAll('*');
            allElements.forEach(element => {
                const style = getComputedStyle(element);
                const zIndex = parseInt(style.zIndex);
                if (zIndex > 0 && style.display !== 'none' && style.visibility !== 'hidden') {
                    const elementRect = element.getBoundingClientRect();
                    if (elementRect.width > 0 && elementRect.height > 0) {
                        // Check if this element overlaps with the canvas
                        if (elementRect.left < rect.right && elementRect.right > rect.left &&
                            elementRect.top < rect.bottom && elementRect.bottom > rect.top) {
                            coveringElements.push({
                                element: element.tagName + (element.id ? '#' + element.id : ''),
                                zIndex: zIndex,
                                rect: elementRect
                            });
                        }
                    }
                }
            });
            
            if (coveringElements.length > 0) {
                console.log('Elements that might be covering the canvas:', coveringElements);
            } else {
                console.log('No obvious covering elements found');
            }
        }
        
        // Force correct layout visibility based on screen size
        function forceLayoutVisibility() {
            const isMobile = window.innerWidth <= 768;
            const mobileLayout = document.querySelector('.mobile-shopify-layout');
            const desktopLayout = document.querySelector('.desktop-layout');
            
            console.log('Force layout visibility - Is mobile:', isMobile);
            
            if (isMobile) {
                // Show mobile layout
                if (mobileLayout) {
                    mobileLayout.style.display = 'flex !important';
                    mobileLayout.style.visibility = 'visible !important';
                    console.log('Mobile layout forced to visible');
                }
                
                // Hide desktop layout
                if (desktopLayout) {
                    desktopLayout.style.display = 'none !important';
                    desktopLayout.style.visibility = 'hidden !important';
                    console.log('Desktop layout forced to hidden');
                }
            } else {
                // Show desktop layout
                if (desktopLayout) {
                    desktopLayout.style.display = 'flex !important';
                    desktopLayout.style.visibility = 'visible !important';
                    console.log('Desktop layout forced to visible');
                }
                
                // Hide mobile layout
                if (mobileLayout) {
                    mobileLayout.style.display = 'none !important';
                    mobileLayout.style.visibility = 'hidden !important';
                    console.log('Mobile layout forced to hidden');
                }
            }
        }
        
        // Force canvas to be visible and properly sized
        function forceCanvasVisibility() {
            const canvas = document.querySelector('canvas');
            if (!canvas) {
                console.error('No canvas found for forceCanvasVisibility');
                return;
            }
            
            console.log('Forcing canvas visibility...');
            
            // Force canvas to be visible
            canvas.style.display = 'block !important';
            canvas.style.visibility = 'visible !important';
            canvas.style.opacity = '1 !important';
            canvas.style.position = 'relative !important';
            canvas.style.zIndex = '1 !important';
            
            // Force canvas dimensions
            canvas.style.width = '100% !important';
            canvas.style.height = '100% !important';
            canvas.style.minWidth = '300px !important';
            canvas.style.minHeight = '300px !important';
            
            // Remove any transforms that might be hiding it
            canvas.style.transform = 'none !important';
            canvas.style.transformOrigin = 'initial !important';
            
            // Ensure parent container is visible and transparent
            const parent = canvas.parentElement;
            if (parent) {
                parent.style.display = 'block !important';
                parent.style.visibility = 'visible !important';
                parent.style.overflow = 'visible !important';
                parent.style.position = 'relative !important';
                parent.style.background = 'transparent !important';
                parent.style.backgroundColor = 'transparent !important';
            }
            
            // Also ensure all ancestor containers are transparent
            let ancestor = parent;
            while (ancestor && ancestor !== document.body) {
                if (ancestor.classList.contains('main-product-viewer') || 
                    ancestor.classList.contains('product-carousel-section') ||
                    ancestor.classList.contains('mobile-shopify-layout')) {
                    ancestor.style.background = 'transparent !important';
                    ancestor.style.backgroundColor = 'transparent !important';
                }
                ancestor = ancestor.parentElement;
            }
            
            console.log('Canvas forced visibility complete');
            
            // Check if canvas is actually visible
            const rect = canvas.getBoundingClientRect();
            console.log('Canvas bounding rect:', rect);
            console.log('Canvas is visible:', rect.width > 0 && rect.height > 0);
            
            // Check computed styles
            const computedStyle = getComputedStyle(canvas);
            console.log('Canvas computed display:', computedStyle.display);
            console.log('Canvas computed visibility:', computedStyle.visibility);
            console.log('Canvas computed opacity:', computedStyle.opacity);
        }
        
        // Update renderer size when canvas is moved
        function updateRendererSize(container) {
            // Try to find the global viewer instance
            if (window.viewer && window.viewer.renderer) {
                const newWidth = container.clientWidth;
                const newHeight = container.clientHeight;
                console.log('Updating renderer size to:', newWidth, 'x', newHeight);
                console.log('Container computed style:', getComputedStyle(container).height);
                console.log('Container offset dimensions:', container.offsetWidth, 'x', container.offsetHeight);
                
                // Force a minimum size if container is too small
                const finalWidth = Math.max(newWidth, 300);
                const finalHeight = Math.max(newHeight, 300);
                
                window.viewer.renderer.setSize(finalWidth, finalHeight);
                
                // Update camera aspect ratio
                if (window.viewer.camera) {
                    window.viewer.camera.aspect = finalWidth / finalHeight;
                    window.viewer.camera.updateProjectionMatrix();
                }
                
                // Update controls if they exist
                if (window.viewer.controls) {
                    window.viewer.controls.update();
                }
                
                // Force a render
                if (window.viewer.renderer && window.viewer.scene && window.viewer.camera) {
                    window.viewer.renderer.render(window.viewer.scene, window.viewer.camera);
                }
            } else {
                console.error('Viewer or renderer not found!');
            }
        }
        
        // Handle responsive layout switching
        function handleResponsiveLayout() {
            const isMobile = window.innerWidth <= 767;
            const ecommerceLayout = document.querySelector('.ecommerce-layout');
            
            if (ecommerceLayout) {
                // Update layout classes based on screen size
                if (isMobile) {
                    ecommerceLayout.classList.add('mobile-layout');
                    ecommerceLayout.classList.remove('desktop-layout');
                } else {
                    ecommerceLayout.classList.add('desktop-layout');
                    ecommerceLayout.classList.remove('mobile-layout');
                }
            }
            
            // Move UI menu to appropriate location
            moveUIMenuToLocation(isMobile);
        }
        
        // Move UI menu to desktop controls section or hide on mobile
        function moveUIMenuToLocation(isMobile) {
            const uiMenu = document.getElementById('ui-menu');
            const uiMenuContainer = document.getElementById('ui-menu-container');
            
            if (!uiMenu) return;
            
            if (isMobile) {
                // Hide UI menu on mobile
                uiMenu.style.display = 'none';
            } else {
                // Show UI menu and move to desktop controls section
                uiMenu.style.display = 'block';
                if (uiMenuContainer && uiMenu.parentElement !== uiMenuContainer) {
                    uiMenuContainer.appendChild(uiMenu);
                }
            }
        }
        
        // Update Three.js renderer for current layout
        function updateRendererForCurrentLayout() {
            if (!window.viewer || !window.viewer.renderer) return;
            
            const canvasContainer = document.getElementById('canvas-container');
            if (!canvasContainer) return;
            
            const containerRect = canvasContainer.getBoundingClientRect();
            const width = Math.max(containerRect.width, 300);
            const height = Math.max(containerRect.height, 300);
            
            console.log('Updating renderer size:', width, 'x', height);
            
            // Update renderer size
            window.viewer.renderer.setSize(width, height);
            
            // Update camera aspect ratio
            if (window.viewer.camera) {
                window.viewer.camera.aspect = width / height;
                window.viewer.camera.updateProjectionMatrix();
            }
            
            // Force render
            if (window.viewer.renderer.render && window.viewer.scene && window.viewer.camera) {
                window.viewer.renderer.render(window.viewer.scene, window.viewer.camera);
            }
        }
        
        // Initialize product option interactions
        function initializeOptionInteractions() {
            console.log('Initializing option interactions...');
            
        }
        
        // Initialize add photo button
        function initializePhotoButton() {
            const addPhotoButton = document.getElementById('add-photo-btn');
            if (addPhotoButton) {
                addPhotoButton.addEventListener('click', function() {
                    // Trigger file input
                    const fileInput = document.getElementById('file-input');
                    if (fileInput) {
                        fileInput.click();
                    }
                });
            }
        }
        
        // Handle view changes from carousel
        function handleViewChange(viewType) {
            console.log('Changing view to:', viewType);
            
            const canvasContainer = document.getElementById('canvas-container');
            const imageViewerContainer = document.getElementById('image-viewer-container');
            const mainImageViewer = document.getElementById('main-image-viewer');
            
            // Hide both containers initially
            if (canvasContainer) canvasContainer.style.display = 'none';
            if (imageViewerContainer) imageViewerContainer.style.display = 'none';
            
            switch(viewType) {
                case '3d':
                    // Show 3D scene
                    if (canvasContainer) {
                        canvasContainer.style.display = 'block';
                    }
                    break;
                case 'sample':
                    // Show sample pendant image
                    if (imageViewerContainer && mainImageViewer) {
                        mainImageViewer.src = '/samplePendant.png';
                        imageViewerContainer.style.display = 'block';
                    }
                    break;
                case 'front':
                    // Show front view image
                    if (imageViewerContainer && mainImageViewer) {
                        mainImageViewer.src = '/retrieverModel.png';
                        imageViewerContainer.style.display = 'block';
                    }
                    break;
                case 'side':
                    // Show side view image
                    if (imageViewerContainer && mainImageViewer) {
                        mainImageViewer.src = '/instructions.png';
                        imageViewerContainer.style.display = 'block';
                    }
                    break;
                case 'retriever-metal':
                    // Show retriever metal image
                    if (imageViewerContainer && mainImageViewer) {
                        mainImageViewer.src = '/retrieverMetal.png';
                        imageViewerContainer.style.display = 'block';
                    }
                    break;
                case 'before':
                    // Show before image
                    if (imageViewerContainer && mainImageViewer) {
                        mainImageViewer.src = '/before.png';
                        imageViewerContainer.style.display = 'block';
                    }
                    break;
                case 'jewelry':
                    // Show jewelry image
                    if (imageViewerContainer && mainImageViewer) {
                        mainImageViewer.src = '/foreverAndEverJewelry.png';
                        imageViewerContainer.style.display = 'block';
                    }
                    break;
                case 'sailing':
                    // Show sailing scene image
                    if (imageViewerContainer && mainImageViewer) {
                        mainImageViewer.src = '/sailingSceneProductPhoto.png';
                        imageViewerContainer.style.display = 'block';
                    }
                    break;
            }
        }
        
        // Update Shopify buy button variant based on metal type
        function updateShopifyVariant(metalType) {
            // Map metal types to Shopify option values
            // Adjust these values to match your Shopify product's option names
            let shopifyOptionValue;
            switch(metalType) {
                case 'silver':
                    shopifyOptionValue = 'Sterling Silver';
                    break;
                case 'gold':
                    shopifyOptionValue = '14K Yellow Gold';
                    break;
                case 'rose-gold':
                    shopifyOptionValue = 'Rose Gold';
                    break;
                case 'stl':
                    shopifyOptionValue = 'STL File';
                    break;
                default:
                    shopifyOptionValue = 'Sterling Silver';
            }
            
            console.log('=== Updating Shopify variant ===');
            console.log('Metal type:', metalType);
            console.log('Target option value:', shopifyOptionValue);
            
            // Try to update, with retry if component not ready
            function attemptUpdate() {
                const productNode = document.getElementById('product-component-1764405426589');
                if (!productNode) {
                    console.log('Shopify product node not found, will retry...');
                    setTimeout(attemptUpdate, 500);
                    return;
                }
                
                try {
                    // Method 1: Try accessing iframe content (Shopify renders in iframe)
                    const iframe = productNode.querySelector('iframe');
                    if (iframe) {
                        console.log('Found Shopify iframe, attempting to access content...');
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                            if (iframeDoc) {
                                // Search inside iframe
                                const optionSelects = iframeDoc.querySelectorAll('select');
                                console.log('Found select elements in iframe:', optionSelects.length);
                                
                                if (optionSelects.length > 0) {
                                    for (let select of optionSelects) {
                                        const options = Array.from(select.options);
                                        console.log('Checking iframe select with options:', options.map(o => o.textContent.trim()));
                                        
                                        let matchingOption = options.find(opt => 
                                            opt.textContent.trim() === shopifyOptionValue ||
                                            opt.textContent.trim().toLowerCase() === shopifyOptionValue.toLowerCase()
                                        );
                                        
                                        if (!matchingOption) {
                                            matchingOption = options.find(opt => 
                                                opt.textContent.trim().toLowerCase().includes(shopifyOptionValue.toLowerCase()) ||
                                                shopifyOptionValue.toLowerCase().includes(opt.textContent.trim().toLowerCase())
                                            );
                                        }
                                        
                                        if (matchingOption) {
                                            select.value = matchingOption.value;
                                            select.dispatchEvent(new Event('change', { bubbles: true }));
                                            select.dispatchEvent(new Event('input', { bubbles: true }));
                                            console.log(' Shopify variant updated via iframe select:', matchingOption.textContent);
                                            return true;
                                        }
                                    }
                                }
                                
                                // Try radio buttons in iframe
                                const radioButtons = iframeDoc.querySelectorAll('input[type="radio"]');
                                if (radioButtons.length > 0) {
                                    for (let radio of radioButtons) {
                                        const label = iframeDoc.querySelector(`label[for="${radio.id}"]`);
                                        const labelText = label ? label.textContent.trim() : '';
                                        if (labelText === shopifyOptionValue || 
                                            labelText.toLowerCase() === shopifyOptionValue.toLowerCase()) {
                                            radio.checked = true;
                                            radio.dispatchEvent(new Event('change', { bubbles: true }));
                                            radio.dispatchEvent(new Event('click', { bubbles: true }));
                                            console.log(' Shopify variant updated via iframe radio button');
                                            return true;
                                        }
                                    }
                                }
                                
                                // Try buttons in iframe
                                const buttons = iframeDoc.querySelectorAll('button, [role="button"]');
                                for (let button of buttons) {
                                    const buttonText = button.textContent.trim();
                                    if (buttonText === shopifyOptionValue || 
                                        buttonText.toLowerCase() === shopifyOptionValue.toLowerCase()) {
                                        button.click();
                                        console.log(' Shopify variant updated via iframe button');
                                        return true;
                                    }
                                }
                            } else {
                                console.warn('Cannot access iframe content (cross-origin restriction)');
                            }
                        } catch (iframeError) {
                            console.warn('Cannot access iframe content:', iframeError.message);
                            console.log('This is likely due to cross-origin restrictions. Trying API method instead...');
                        }
                    }
                    
                    // Method 2: Use Shopify Buy Button SDK API (preferred method)
                    const component = window.shopifyProductComponent;
                    if (component && component.model) {
                        const model = component.model;
                        console.log('Using Shopify component model API');
                        
                        if (model.variants && model.variants.length > 0) {
                            console.log('Available variants:', model.variants.map(v => ({
                                id: v.id,
                                title: v.title,
                                options: v.selectedOptions?.map(o => ({ name: o.name, value: o.value }))
                            })));
                            
                            // Find variant that matches the metal type
                            const matchingVariant = model.variants.find(variant => {
                                if (variant.selectedOptions && variant.selectedOptions.length > 0) {
                                    // Check if any option matches our target value
                                    return variant.selectedOptions.some(option => {
                                        const optionValue = option.value || '';
                                        return optionValue === shopifyOptionValue ||
                                               optionValue.toLowerCase() === shopifyOptionValue.toLowerCase() ||
                                               optionValue.toLowerCase().includes(shopifyOptionValue.toLowerCase()) ||
                                               shopifyOptionValue.toLowerCase().includes(optionValue.toLowerCase());
                                    });
                                }
                                return false;
                            });
                            
                            if (matchingVariant) {
                                console.log('Found matching variant:', matchingVariant);
                                
                                // Try different methods to set the variant
                                if (typeof model.selectVariant === 'function') {
                                    model.selectVariant(matchingVariant);
                                    console.log(' Called model.selectVariant()');
                                } else if (typeof model.setVariant === 'function') {
                                    model.setVariant(matchingVariant);
                                    console.log(' Called model.setVariant()');
                                } else if (typeof model.setSelectedVariant === 'function') {
                                    model.setSelectedVariant(matchingVariant);
                                    console.log(' Called model.setSelectedVariant()');
                                } else {
                                    // Direct assignment
                                    model.selectedVariant = matchingVariant;
                                    console.log(' Set model.selectedVariant directly');
                                }
                                
                                // Try to trigger a re-render
                                if (component.update) {
                                    component.update();
                                } else if (component.render) {
                                    component.render();
                                } else if (window.shopifyBuyUI && window.shopifyBuyUI.updateComponent) {
                                    window.shopifyBuyUI.updateComponent(component);
                                }
                                
                                console.log(' Shopify variant updated via model API');
                                return true;
                            } else {
                                console.warn('No matching variant found. Available option values:', 
                                    model.variants.flatMap(v => 
                                        v.selectedOptions?.map(o => o.value) || []
                                    )
                                );
                            }
                        }
                    }
                    
                    // Method 3: Find and update select dropdown in main DOM (fallback)
                    const optionSelects = productNode.querySelectorAll('select');
                    console.log('Found select elements in main DOM:', optionSelects.length);
                    
                    if (optionSelects.length > 0) {
                        // Try each select to find the one with metal options
                        for (let select of optionSelects) {
                            const options = Array.from(select.options);
                            console.log('Checking select with options:', options.map(o => o.textContent.trim()));
                            
                            // Try exact match first
                            let matchingOption = options.find(opt => 
                                opt.textContent.trim() === shopifyOptionValue
                            );
                            
                            // Try case-insensitive match
                            if (!matchingOption) {
                                matchingOption = options.find(opt => 
                                    opt.textContent.trim().toLowerCase() === shopifyOptionValue.toLowerCase()
                                );
                            }
                            
                            // Try partial match
                            if (!matchingOption) {
                                matchingOption = options.find(opt => 
                                    opt.textContent.trim().toLowerCase().includes(shopifyOptionValue.toLowerCase()) ||
                                    shopifyOptionValue.toLowerCase().includes(opt.textContent.trim().toLowerCase())
                                );
                            }
                            
                            if (matchingOption) {
                                select.value = matchingOption.value;
                                // Trigger multiple events to ensure Shopify picks it up
                                select.dispatchEvent(new Event('change', { bubbles: true }));
                                select.dispatchEvent(new Event('input', { bubbles: true }));
                                // Also try native change
                                if (select.onchange) select.onchange();
                                console.log(' Shopify variant updated via select:', matchingOption.textContent);
                                return true;
                            }
                        }
                    }
                    
                    // Method 2: Try radio buttons
                    const radioButtons = productNode.querySelectorAll('input[type="radio"]');
                    console.log('Found radio buttons:', radioButtons.length);
                    if (radioButtons.length > 0) {
                        for (let radio of radioButtons) {
                            const label = productNode.querySelector(`label[for="${radio.id}"]`);
                            const labelText = label ? label.textContent.trim() : '';
                            const radioValue = radio.value || '';
                            
                            if (labelText === shopifyOptionValue || 
                                labelText.toLowerCase() === shopifyOptionValue.toLowerCase() ||
                                radioValue.toLowerCase().includes(shopifyOptionValue.toLowerCase())) {
                                radio.checked = true;
                                radio.dispatchEvent(new Event('change', { bubbles: true }));
                                radio.dispatchEvent(new Event('click', { bubbles: true }));
                                console.log(' Shopify variant updated via radio button');
                                return true;
                            }
                        }
                    }
                    
                    // Method 3: Try buttons
                    const buttons = productNode.querySelectorAll('button, [role="button"]');
                    console.log('Found buttons:', buttons.length);
                    for (let button of buttons) {
                        const buttonText = button.textContent.trim();
                        if (buttonText === shopifyOptionValue || 
                            buttonText.toLowerCase() === shopifyOptionValue.toLowerCase()) {
                            button.click();
                            console.log(' Shopify variant updated via button click');
                            return true;
                        }
                    }
                    
                    console.warn(' Could not find matching option for:', shopifyOptionValue);
                    console.log('Product node HTML:', productNode.innerHTML.substring(0, 500));
                    return false;
                    
                } catch (error) {
                    console.error(' Error updating Shopify variant:', error);
                    console.error('Error stack:', error.stack);
                    return false;
                }
            }
            
            // Start the update attempt
            attemptUpdate();
        }
        
        // Update metal type - make globally accessible for Shopify reverse sync
        window.updateMetalType = function(metalType) {
            console.log('=== updateMetalType called ===');
            console.log('Metal type requested:', metalType);
            console.log('Window.viewer exists:', !!window.viewer);
            console.log('Window.viewer.updateMetalMaterial exists:', !!(window.viewer && window.viewer.updateMetalMaterial));
            
            // Map ecommerce UI metal types to material types
            let materialType;
            switch(metalType) {
                case 'silver':
                    materialType = 'sterling-silver';
                    break;
                case 'gold':
                    materialType = 'gold-14k';
                    break;
                case 'rose-gold':
                    materialType = 'rose-gold-14k';
                    break;
                case 'stl':
                    materialType = 'stl'; // Use stl material type for STL text
                    break;
                default:
                    materialType = 'sterling-silver';
            }
            
            console.log('Mapped to material type:', materialType);
            
            // Update the 3D material if viewer exists
            if (window.viewer && window.viewer.updateMetalMaterial) {
                console.log('Calling viewer.updateMetalMaterial...');
                window.viewer.updateMetalMaterial(materialType);
            } else {
                console.warn('Viewer not ready yet. Retrying in 500ms...');
                setTimeout(() => {
                    if (window.viewer && window.viewer.updateMetalMaterial) {
                        console.log('Retrying viewer.updateMetalMaterial...');
                        window.viewer.updateMetalMaterial(materialType);
                    } else {
                        console.error('Viewer still not available after retry');
                        console.log('Available viewer methods:', window.viewer ? Object.getOwnPropertyNames(Object.getPrototypeOf(window.viewer)) : 'No viewer');
                    }
                }, 500);
            }
            
            // Update the original metal type select if it exists
            const metalSelect = document.getElementById('metal-type');
            if (metalSelect) {
                console.log('Updating metal-type select to:', materialType);
                metalSelect.value = materialType;
                // Trigger change event to sync other UI
                metalSelect.dispatchEvent(new Event('change'));
            } else {
                console.log('metal-type select not found');
            }
            
            // Update Shopify buy button variant (only if not updating from Shopify)
            if (!window.updatingFromShopify) {
              updateShopifyVariant(metalType);
        }
        };
        
        // Update price based on metal type
        // Initialize Imagine button functionality
        function initializeImagineButton() {
            console.log(' Initializing Imagine button...');
            
            // Initialize immediately - no delay
            function init() {
                const imagineButton = document.querySelector('.imagine-button');
                const aiPromptModal = document.getElementById('ai-prompt-modal');
                const aiPromptInput = document.getElementById('ai-prompt-input-modal');
                const generateBtn = document.getElementById('generate-ai-btn-modal');
                const cancelBtn = document.getElementById('cancel-ai-btn-modal');
                
                if (!imagineButton || !aiPromptModal || !aiPromptInput || !generateBtn || !cancelBtn) {
                    console.error(' Missing elements for Imagine button:', {
                        imagineButton: !!imagineButton,
                        aiPromptModal: !!aiPromptModal,
                        aiPromptInput: !!aiPromptInput,
                        generateBtn: !!generateBtn,
                        cancelBtn: !!cancelBtn
                    });
                    return;
                }
                
                console.log(' All Imagine button elements found');
                
                // Show modal when Imagine button is clicked
                imagineButton.addEventListener('click', () => {
                    console.log(' Imagine button clicked, showing modal...');
                    aiPromptModal.style.display = 'block';
                    aiPromptInput.focus();
                    document.body.style.overflow = 'hidden'; // Prevent background scroll
                });
                
                // Hide modal when clicking outside
                aiPromptModal.addEventListener('click', (e) => {
                    if (e.target === aiPromptModal) {
                        aiPromptModal.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });
                
                // Hide modal on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && aiPromptModal.style.display === 'block') {
                        aiPromptModal.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });
                
                // Cancel button
                cancelBtn.addEventListener('click', () => {
                    aiPromptModal.style.display = 'none';
                    document.body.style.overflow = '';
                    aiPromptInput.value = '';
                });
                
                // Generate button - use the viewer's existing AI generation capability
                generateBtn.addEventListener('click', async () => {
                    const prompt = aiPromptInput.value.trim();
                    
                    if (!prompt) {
                        alert('Please enter a prompt to generate an image');
                        return;
                    }
                    
                    console.log(' Generate button clicked with prompt:', prompt);
                    
                    try {
                        // Find the original prompt elements immediately (don't wait for viewer)
                        const promptInput = document.getElementById('ai-prompt-input');
                        const promptSubmitBtn = document.getElementById('generate-ai-btn');
                        
                        console.log(' Looking for original UI elements:', {
                            promptInput: !!promptInput,
                            promptSubmitBtn: !!promptSubmitBtn
                        });
                            
                            // Close modal first
                            aiPromptModal.style.display = 'none';
                            document.body.style.overflow = '';
                            aiPromptInput.value = '';
                            
                        // Directly call the AI generation function and handle the returned image
                        let imageDataUrl = null;
                        if (window.viewer && typeof window.viewer.generateImageWithOpenAI === 'function') {
                            console.log(' Calling generateImageWithOpenAI directly...');
                            try {
                                imageDataUrl = await window.viewer.generateImageWithOpenAI(prompt);
                                console.log(' AI generation completed successfully, imageDataUrl length:', imageDataUrl ? imageDataUrl.length : 'null');
                            } catch (genError) {
                                console.error(' Error in generateImageWithOpenAI:', genError);
                                throw genError;
                            }
                        } else if (window.generateImageWithOpenAI && typeof window.generateImageWithOpenAI === 'function') {
                            console.log(' Calling window.generateImageWithOpenAI directly...');
                            try {
                                imageDataUrl = await window.generateImageWithOpenAI(prompt);
                                console.log(' AI generation completed successfully, imageDataUrl length:', imageDataUrl ? imageDataUrl.length : 'null');
                            } catch (genError) {
                                console.error(' Error in generateImageWithOpenAI:', genError);
                                throw genError;
                            }
                        } else {
                            throw new Error('AI generation function not available. Please ensure the viewer is initialized.');
                        }
                        
                        // If we got an image, show the cropper modal
                        if (imageDataUrl) {
                            console.log(' About to show cropper modal with generated image');
                            
                            // Upload DALL-E image to S3 immediately
                            console.log(' Uploading DALL-E image to S3 immediately...');
                            fetch(imageDataUrl).then(response => response.blob()).then(async (imageBlob) => {
                                if (window.uploadDalleImageToS3 && typeof window.uploadDalleImageToS3 === 'function') {
                                    try {
                                        const uploadResult = await window.uploadDalleImageToS3(imageBlob, prompt);
                                        console.log(' DALL-E image uploaded to S3:', uploadResult.filename);
                                    } catch (error) {
                                        console.error(' DALL-E image upload failed:', error);
                                    }
                                }
                            }).catch(error => {
                                console.error(' Failed to convert DALL-E image to blob:', error);
                            });
                            
                            // Determine crop shape based on current object type
                            const currentObjectType = window.viewer && window.viewer.currentObjectType ? window.viewer.currentObjectType : null;
                            const cropShape = (currentObjectType === 'circular-pendant' || currentObjectType === 'circular-stud') ? 'circle' : 'rect';
                            console.log(' Crop shape determined:', cropShape, 'from object type:', currentObjectType);
                                
                            // Show cropper modal
                            if (window.showCropperModal && typeof window.showCropperModal === 'function') {
                                window.showCropperModal(imageDataUrl, (croppedBlob) => {
                                    console.log(' Cropper callback triggered with blob size:', croppedBlob.size);
                                    
                                    // Upload cropped image to S3 in the background (from DALL-E)
                                    if (window.uploadCroppedImageToS3 && typeof window.uploadCroppedImageToS3 === 'function') {
                                        window.uploadCroppedImageToS3(croppedBlob, true).then(uploadResult => {
                                            console.log(' Cropped image uploaded to S3:', uploadResult.filename);
                                            // Store cropped image GUID for Shopify order
                                            if (uploadResult.guid) {
                                                sessionStorage.setItem('croppedImageGuid', uploadResult.guid);
                                                console.log(' Cropped image GUID stored:', uploadResult.guid);
                                            }
                                        }).catch(error => {
                                            console.error(' Failed to upload cropped image to S3:', error);
                                            // Don't block processing if upload fails
                                        });
                                    } else {
                                        console.warn(' uploadCroppedImageToS3 not available, skipping S3 upload');
                                    }
                                    
                                    // Process the image
                                    if (window.viewer && typeof window.viewer.processImage === 'function') {
                                        window.viewer.processImage(croppedBlob);
                            } else {
                                        console.error(' viewer.processImage not available');
                                        alert('Failed to process image. Please refresh the page and try again.');
                                    }
                                }, null, cropShape);
                            } else {
                                console.error(' showCropperModal not available');
                                alert('Failed to show image cropper. Please refresh the page and try again.');
                            }
                        } else {
                            console.error(' Image generation returned null/empty data URL');
                            alert('Failed to generate image. Please try again.');
                        }
                        
                    } catch (error) {
                        console.error(' Error generating image:', error);
                        alert(`Failed to generate image: ${error.message}`);
                    }
                });
                
                console.log(' Imagine button initialized successfully');
            }
            
            // Try to initialize immediately
            init();
            
            // If elements not ready, check periodically (but quickly)
            if (!document.querySelector('.imagine-button')) {
                const checkInterval = setInterval(() => {
                    if (document.querySelector('.imagine-button')) {
                        clearInterval(checkInterval);
                        init();
                    }
                }, 10); // Check every 10ms instead of waiting 1 second
            }
        }
    </script>
    
    <!-- Infinite Scrolling Testimonials -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const testimonialsContainer = document.getElementById('testimonials-container');
            if (!testimonialsContainer) return;

            // Config
            const pixelsPerMs = 0.083; // ~25% slower
            let isPaused = false;
            let rafId = null;
            let lastTs = null;
            let halfWidth = 0;

            function computeHalfWidth() {
                halfWidth = (testimonialsContainer.scrollWidth / 2) - 40;
            }

            function createInfiniteScroll() {
                const testimonials = Array.from(testimonialsContainer.children);
                testimonials.forEach(node => {
                    testimonialsContainer.appendChild(node.cloneNode(true));
                });
                computeHalfWidth();
            }

            function step(ts) {
                if (isPaused) {
                    lastTs = ts;
                    rafId = requestAnimationFrame(step);
                    return;
                }
                if (lastTs === null) lastTs = ts;
                const delta = ts - lastTs;
                lastTs = ts;

                testimonialsContainer.scrollLeft = (testimonialsContainer.scrollLeft + delta * pixelsPerMs) % halfWidth;
                rafId = requestAnimationFrame(step);
            }

            function start() {
                if (rafId) cancelAnimationFrame(rafId);
                lastTs = null;
                rafId = requestAnimationFrame(step);
            }

            function pause() {
                isPaused = true;
            }
            function resume() {
                isPaused = false;
            }

            createInfiniteScroll();
            testimonialsContainer.style.scrollBehavior = 'auto';
            start();

            testimonialsContainer.addEventListener('mouseenter', pause);
            testimonialsContainer.addEventListener('mouseleave', resume);
            testimonialsContainer.addEventListener('touchstart', pause);
            testimonialsContainer.addEventListener('touchend', () => setTimeout(resume, 800));
            window.addEventListener('resize', computeHalfWidth);
        });
    </script>
    
    <!-- Add this in the <head> or before the closing </body> tag -->
    <script id="threejs-font-json" type="application/json">
    // The font will be loaded via JS from the official Three.js CDN
    </script>
    <!-- Optionally, add FontLoader via module import in main.js -->
    
    <!-- Shopify Buy Button Script -->
    <script type="text/javascript">
    /*<![CDATA[*/
    (function () {
      var scriptURL = 'https://sdks.shopifycdn.com/buy-button/latest/buy-button-storefront.min.js';
      if (window.ShopifyBuy) {
        if (window.ShopifyBuy.UI) {
          ShopifyBuyInit();
        } else {
          loadScript();
        }
      } else {
        loadScript();
      }
      function loadScript() {
        var script = document.createElement('script');
        script.async = true;
        script.src = scriptURL;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(script);
        script.onload = ShopifyBuyInit;
      }
      // Store Shopify component reference globally
      window.shopifyProductComponent = null;
      
      function ShopifyBuyInit() {
        var client = ShopifyBuy.buildClient({
          domain: 'z0u750-mb.myshopify.com',
          storefrontAccessToken: '73a8e88f430939341abe6e2afdd62d90',
        });
        ShopifyBuy.UI.onReady(client).then(function (ui) {
          // Store UI instance for later access
          window.shopifyBuyUI = ui;
          
          var component = ui.createComponent('product', {
            id: '10066983190819',
            node: document.getElementById('product-component-1764405426589'),
            moneyFormat: '%24%7B%7Bamount%7D%7D',
            options: {
      "product": {
        "styles": {
          "product": {
            "@media (min-width: 601px)": {
              "max-width": "100%",
              "margin-left": "0",
              "margin-bottom": "50px"
            },
            "text-align": "left"
          },
          "title": {
            "font-size": "26px"
          },
          "button": {
            ":hover": {
              "background-color": "#4e63a4"
            },
            "background-color": "#576eb6",
            ":focus": {
              "background-color": "#4e63a4"
            },
            "border-radius": "31px",
            "width": "100%",
            "padding": "16px 0"
          },
          "price": {
            "font-size": "18px"
          },
          "compareAt": {
            "font-size": "15.299999999999999px"
          },
          "unitPrice": {
            "font-size": "15.299999999999999px"
          }
        },
        "buttonDestination": "checkout",
        "layout": "horizontal",
        "contents": {
          "img": false,
          "imgWithCarousel": true,
          "description": true
        },
        "width": "100%",
        "text": {
          "button": "Buy Now"
        }
      },
      "productSet": {
        "styles": {
          "products": {
            "@media (min-width: 601px)": {
              "margin-left": "-20px"
            }
          }
        }
      },
      "modalProduct": {
        "contents": {
          "img": false,
          "imgWithCarousel": true,
          "button": false,
          "buttonWithQuantity": true
        },
        "styles": {
          "product": {
            "@media (min-width: 601px)": {
              "max-width": "100%",
              "margin-left": "0px",
              "margin-bottom": "0px"
            }
          },
          "button": {
            ":hover": {
              "background-color": "#4e63a4"
            },
            "background-color": "#576eb6",
            ":focus": {
              "background-color": "#4e63a4"
            },
            "border-radius": "31px"
          },
          "title": {
            "font-family": "Helvetica Neue, sans-serif",
            "font-weight": "bold",
            "font-size": "26px",
            "color": "#4c4c4c"
          },
          "price": {
            "font-family": "Helvetica Neue, sans-serif",
            "font-weight": "normal",
            "font-size": "18px",
            "color": "#4c4c4c"
          },
          "compareAt": {
            "font-family": "Helvetica Neue, sans-serif",
            "font-weight": "normal",
            "font-size": "15.299999999999999px",
            "color": "#4c4c4c"
          },
          "unitPrice": {
            "font-family": "Helvetica Neue, sans-serif",
            "font-weight": "normal",
            "font-size": "15.299999999999999px",
            "color": "#4c4c4c"
          }
        },
        "text": {
          "button": "Add to cart"
        }
      },
      "option": {},
      "cart": {
        "styles": {
          "button": {
            ":hover": {
              "background-color": "#4e63a4"
            },
            "background-color": "#576eb6",
            ":focus": {
              "background-color": "#4e63a4"
            },
            "border-radius": "31px"
          }
        },
        "text": {
          "total": "Subtotal",
          "button": "Checkout"
        }
      },
      "toggle": {
        "styles": {
          "toggle": {
            "background-color": "#576eb6",
            ":hover": {
              "background-color": "#4e63a4"
            },
            ":focus": {
              "background-color": "#4e63a4"
            }
          }
        }
      }
    },
          });
          
          // Store component reference globally for variant updates
          window.shopifyProductComponent = component;
          
          // Set up reverse sync: Listen for Shopify variant changes via iframe (more reliable)
          function setupShopifyVariantListener() {
            const productNode = document.getElementById('product-component-1764405426589');
            if (!productNode) {
              console.log('Product node not found, retrying...');
              setTimeout(setupShopifyVariantListener, 500);
              return;
            }
            
            const iframe = productNode.querySelector('iframe');
            if (!iframe) {
              console.log('Iframe not found, retrying...');
              setTimeout(setupShopifyVariantListener, 500);
              return;
            }
            
            try {
              const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
              if (!iframeDoc) {
                console.log('Cannot access iframe document, retrying...');
                setTimeout(setupShopifyVariantListener, 500);
                return;
              }
              
              console.log(' Setting up Shopify variant change listener via iframe');
              
              // Map Shopify option values back to metal types
              function mapShopifyOptionToMetalType(optionValue) {
                if (!optionValue) return null;
                
                const value = optionValue.toLowerCase();
                
                // Map Shopify option values to our metal types
                if (value.includes('sterling') || value.includes('silver')) {
                  return 'silver';
                } else if (value.includes('yellow gold') || value.includes('14k yellow')) {
                  return 'gold';
                } else if (value.includes('rose gold') || value.includes('14k rose')) {
                  return 'rose-gold';
                } else if (value.includes('stl')) {
                  return 'stl';
                }
                
                return null;
              }
              
              // Function to handle variant changes from iframe
              function handleVariantChangeFromIframe() {
                // Get the select element from iframe
                const select = iframeDoc.querySelector('select');
                if (!select) {
                  return;
                }
                
                const selectedOption = select.options[select.selectedIndex];
                if (!selectedOption) {
                  return;
                }
                
                const optionValue = selectedOption.textContent.trim();
                console.log('=== Shopify variant changed ===');
                console.log('Selected option:', optionValue);
                
                // Map to our metal type
                const metalType = mapShopifyOptionToMetalType(optionValue);
                if (metalType) {
                  console.log('Mapped to metal type:', metalType);
                  
                  // Update Three.js material (but prevent circular updates)
                  if (window.updateMetalType && !window.updatingFromShopify) {
                    window.updatingFromShopify = true;
                    window.updateMetalType(metalType);
                    // Reset flag after a short delay
                    setTimeout(() => {
                      window.updatingFromShopify = false;
                    }, 100);
                  }
                } else {
                  console.warn('Could not map Shopify option to metal type:', optionValue);
                }
              }
              
              // Listen for change events on select elements
              iframeDoc.addEventListener('change', function(e) {
                if (e.target.tagName === 'SELECT') {
                  console.log('Iframe select changed');
                  setTimeout(handleVariantChangeFromIframe, 50);
                }
              }, true);
              
              // Also poll for changes (backup method)
              let lastSelectedValue = '';
              setInterval(function() {
                const select = iframeDoc.querySelector('select');
                if (select) {
                  const currentValue = select.options[select.selectedIndex]?.textContent.trim();
                  if (currentValue && currentValue !== lastSelectedValue) {
                    lastSelectedValue = currentValue;
                    console.log('Detected select value change via polling:', currentValue);
                    handleVariantChangeFromIframe();
                  }
                }
              }, 300);
              
              console.log(' Added iframe event listeners for reverse sync');
              
            } catch (e) {
              console.error('Cannot access iframe for event listeners:', e);
              // Retry after delay
              setTimeout(setupShopifyVariantListener, 1000);
            }
          }
          
          // Start setting up the listener after a delay to ensure iframe is loaded
          setTimeout(setupShopifyVariantListener, 2000);
          
          // Also wait for component to be fully rendered, then set up observer
          setTimeout(function() {
            const productNode = document.getElementById('product-component-1764405426589');
            if (productNode) {
              console.log('Shopify product component DOM ready');
              console.log('Component structure:', {
                component: component,
                node: productNode,
                hasModel: !!(component && component.model),
                selectElements: productNode.querySelectorAll('select').length
              });
            }
          }, 1000);
          
          // Store component globally for access
          window.shopifyProductComponent = component;
          console.log('Shopify product component initialized and stored');
          console.log(' Component stored:', !!window.shopifyProductComponent);
          
          // Intercept Buy Now button click to generate and upload STL
          function setupBuyNowInterceptor() {
            console.log(' setupBuyNowInterceptor called');
            const productNode = document.getElementById('product-component-1764405426589');
            console.log(' Product node:', productNode);
            
            if (!productNode) {
              console.log(' Product node not found, retrying in 500ms...');
              setTimeout(setupBuyNowInterceptor, 500);
              return;
            }
            
            console.log(' Product node found');
            console.log(' Product node HTML:', productNode.innerHTML.substring(0, 500));
            console.log(' Checking for window.viewer:', !!window.viewer);
            console.log(' Checking for window.generateAndUploadSTL:', typeof window.generateAndUploadSTL);
            console.log(' Checking for window.shopifyProductComponent:', !!window.shopifyProductComponent);
            
            // Try to use Shopify's event system if available
            const shopifyComponent = window.shopifyProductComponent || component;
            if (window.shopifyBuyUI && shopifyComponent) {
              console.log(' Attempting to use Shopify UI event system...');
              try {
                // Listen for cart events
                if (shopifyComponent.on) {
                  // Only listen to cart:add if not already processed
                  let cartAddProcessed = false;
                  shopifyComponent.on('cart:add', function(event) {
                    console.log(' ===== Shopify cart:add event detected! =====');
                    
                    // Prevent duplicate processing
                    if (cartAddProcessed) {
                      console.log(' cart:add already processed, skipping');
                      return;
                    }
                    cartAddProcessed = true;
                    
                    // Generate Order ID if not already generated
                    if (typeof window.generateStlOrderId === 'function' && !sessionStorage.getItem('stlOrderId')) {
                      window.generateStlOrderId();
                    }
                    
                    // Trigger STL generation in background - don't block checkout
                    if (window.viewer && window.generateAndUploadSTL) {
                      console.log(' Triggering STL generation in background from cart:add event...');
                      // Fire and forget - don't await
                      setTimeout(() => {
                        window.generateAndUploadSTL().catch(err => {
                          console.error(' STL error (non-blocking):', err);
                        });
                      }, 0);
                    } else {
                      console.warn(' Viewer or STL function not available');
                    }
                  });
                  
                  // Listen for checkout events
                  shopifyComponent.on('checkout', function(event) {
                    console.log(' ===== Shopify checkout event detected! =====');
                    console.log(' Checkout event details:', event);
                    
                    const orderId = sessionStorage.getItem('stlOrderId');
                    const croppedImageGuid = sessionStorage.getItem('croppedImageGuid');
                    const sessionUUID = typeof getSessionUUID === 'function' ? getSessionUUID() : sessionStorage.getItem('sessionUUID');
                    
                    if (!orderId && typeof window.generateStlOrderId === 'function') {
                      window.generateStlOrderId();
                    }
                    
                    // Try to modify checkout URL if event provides access
                    if (event && event.detail && event.detail.url) {
                      try {
                        const urlObj = new URL(event.detail.url);
                        if (orderId) {
                          urlObj.searchParams.set('attributes[STL Order ID]', orderId);
                        }
                        if (sessionUUID) {
                          urlObj.searchParams.set('attributes[Session UUID]', sessionUUID);
                        }
                        if (croppedImageGuid) {
                          urlObj.searchParams.set('attributes[Cropped Image GUID]', croppedImageGuid);
                        }
                        event.detail.url = urlObj.toString();
                        console.log(' Modified checkout URL with attributes:', event.detail.url);
                      } catch (e) {
                        console.warn(' Could not modify checkout URL:', e);
                      }
                    }
                    
                    // Also set up a listener for when checkout window opens
                    setTimeout(() => {
                      // Monitor for checkout URLs in new windows
                      const checkForCheckoutWindows = () => {
                        // This will be handled by the URL interceptor
                        console.log(' Checkout window opened, attributes should be added by interceptor');
                      };
                      checkForCheckoutWindows();
                    }, 100);
                  });
                  
                  // Listen for button clicks through Shopify's system (but only once)
                  let componentClickProcessed = false;
                  shopifyComponent.on('click', function(event) {
                    // Prevent duplicate processing
                    if (componentClickProcessed) {
                      return;
                    }
                    componentClickProcessed = true;
                    
                    console.log(' ===== Shopify component click event =====');
                    
                    // Generate Order ID if not already generated
                    if (typeof window.generateStlOrderId === 'function' && !sessionStorage.getItem('stlOrderId')) {
                      window.generateStlOrderId();
                    }
                    
                    // Trigger STL generation in background - don't block
                    if (window.viewer && window.generateAndUploadSTL) {
                      console.log(' Triggering STL generation in background from click event...');
                      setTimeout(() => {
                        window.generateAndUploadSTL().catch(err => {
                          console.error(' STL error (non-blocking):', err);
                        });
                      }, 0);
                    }
                  });
                  
                  console.log(' Shopify event listeners added');
                } else {
                  console.warn(' Component.on method not available');
                }
              } catch (e) {
                console.warn(' Could not add Shopify event listeners:', e);
                console.warn(' Error details:', e.message, e.stack);
              }
            } else {
              console.warn(' Shopify UI or component not available');
              console.warn(' shopifyBuyUI:', !!window.shopifyBuyUI);
              console.warn(' shopifyComponent:', !!shopifyComponent);
            }
            
            // Find the iframe containing the Shopify button
            const iframes = productNode.querySelectorAll('iframe');
            console.log(' Found iframes:', iframes.length);
            
            iframes.forEach((iframe, index) => {
              console.log(` Processing iframe ${index + 1}...`);
              try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                if (iframeDoc) {
                  console.log(` Can access iframe ${index + 1} document`);
                  // Helper to match Buy Now button style with squarer rounding
                  const styleBuyNowButton = (btn) => {
                    if (!btn) return;
                    const getVar = (name, fallback) => {
                      const val = getComputedStyle(document.documentElement).getPropertyValue(name)?.trim();
                      return val || fallback;
                    };
                    const accent = getVar('--oxblood', '#9C8F82');
                    const accentStrong = getVar('--oxblood-strong', '#7C6F64');
                    const paper = getVar('--bg-parchment', '#F3EFE8');
                    btn.style.borderRadius = '10px';
                    btn.style.padding = '12px 16px';
                    btn.style.minHeight = '48px';
                    btn.style.minWidth = '160px';
                    btn.style.fontWeight = '700';
                    btn.style.letterSpacing = '0.01em';
                    btn.style.fontSize = '14px';
                    btn.style.lineHeight = '1.15';
                    btn.style.background = accent;
                    btn.style.color = paper;
                    btn.style.border = `1px solid ${accent}`;
                    btn.style.boxShadow = '0 8px 18px rgba(0, 0, 0, 0.18)';
                    btn.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease';
                    btn.style.display = 'inline-block';
                    btn.onmouseenter = () => {
                      btn.style.transform = 'translateY(-2px)';
                      btn.style.boxShadow = '0 10px 22px rgba(0, 0, 0, 0.24)';
                      btn.style.background = accentStrong;
                      btn.style.borderColor = accentStrong;
                    };
                    btn.onmouseleave = () => {
                      btn.style.transform = 'translateY(0)';
                      btn.style.boxShadow = '0 8px 18px rgba(0, 0, 0, 0.18)';
                      btn.style.background = accent;
                      btn.style.borderColor = accent;
                    };
                  };
                  // Look for Buy Now button
                  const buyNowButtons = iframeDoc.querySelectorAll('button, [role="button"], a[href*="cart"]');
                  console.log(` Found ${buyNowButtons.length} potential buttons in iframe ${index + 1}`);
                  
                  buyNowButtons.forEach((button, btnIndex) => {
                    const buttonText = button.textContent.trim().toLowerCase();
                    const ariaLabel = button.getAttribute('aria-label')?.toLowerCase() || '';
                    console.log(` Button ${btnIndex + 1}: text="${buttonText}", aria-label="${ariaLabel}"`);
                    
                    if (buttonText.includes('buy now') || buttonText.includes('buy') || ariaLabel.includes('buy')) {
                      console.log(` Found Buy Now button ${btnIndex + 1}, adding interceptor`);
                      styleBuyNowButton(button);
                      
                      // Remove existing listeners and add our interceptor
                      // Mark button to prevent duplicate listeners
                      if (button.dataset.stlListenerAdded === 'true') {
                        console.log(' Listener already added to this button, skipping');
                        return;
                      }
                      button.dataset.stlListenerAdded = 'true';
                      
                      button.addEventListener('click', function(e) {
                        console.log(' ===== Buy Now button clicked (iframe method) =====');
                        
                        // Prevent duplicate processing
                        if (e.target.dataset.stlProcessed === 'true') {
                          console.log(' Button already processed, skipping');
                          return;
                        }
                        e.target.dataset.stlProcessed = 'true';
                        
                        // Generate Order ID IMMEDIATELY before checkout opens (only if not already generated)
                        if (typeof window.generateStlOrderId === 'function' && !sessionStorage.getItem('stlOrderId')) {
                          const orderId = window.generateStlOrderId();
                          console.log(' Order ID generated and added to checkout:', orderId);
                        }
                        
                        // Trigger STL generation in background - DO NOT BLOCK
                        if (window.viewer && window.generateAndUploadSTL) {
                          console.log(' Triggering STL generation in background (non-blocking)...');
                          // Fire and forget - use setTimeout to ensure checkout opens immediately
                          setTimeout(() => {
                            window.generateAndUploadSTL().catch(err => {
                              console.error(' STL error (non-blocking):', err);
                            });
                          }, 0);
                        }
                        
                        // DO NOT prevent default - let Shopify handle checkout immediately
                        // DO NOT await - allow normal flow to continue
                      }, true); // Use capture phase to intercept early
                    }
                  });
                  
                  // Also monitor for dynamically added buttons
                  const observer = new MutationObserver(() => {
                    const newButtons = iframeDoc.querySelectorAll('button, [role="button"], a[href*="cart"]');
                    newButtons.forEach(button => {
                      const buttonText = button.textContent.trim().toLowerCase();
                      if (buttonText.includes('buy now') || buttonText.includes('buy')) {
                        if (!button.dataset.stlInterceptorAdded) {
                          button.dataset.stlInterceptorAdded = 'true';
                          styleBuyNowButton(button);
                          console.log(' Adding interceptor to dynamically added Buy Now button');
                          button.addEventListener('click', function(e) {
                            console.log(' Buy Now button clicked (dynamic) - generating Order ID...');
                            
                            // Generate Order ID IMMEDIATELY
                            if (typeof window.generateStlOrderId === 'function') {
                              window.generateStlOrderId();
                            }
                            
                            // Fire and forget - don't block checkout
                            if (window.viewer && window.generateAndUploadSTL) {
                              setTimeout(() => {
                                window.generateAndUploadSTL().catch(err => {
                                  console.error(' STL error (non-blocking):', err);
                                });
                              }, 0);
                            }
                          }, true);
                        }
                      }
                    });
                  });
                  
                  observer.observe(iframeDoc.body, { childList: true, subtree: true });
                  console.log(' MutationObserver set up for iframe', index + 1);
                } else {
                  console.log(` Cannot access iframe ${index + 1} document (cross-origin or not loaded)`);
                }
              } catch (e) {
                // Cross-origin restriction - try alternative method
                console.log(` Cannot access iframe ${index + 1} directly:`, e.message);
              }
            });
            
            // Alternative method: Monitor clicks on the product node itself (disabled to prevent duplicates)
            // This is redundant since we have document-level listener
            console.log(' Alternative click listener disabled to prevent duplicates');
          }
          
          // Set up Buy Now interceptor - try multiple times with increasing delays
          console.log(' Scheduling setupBuyNowInterceptor...');
          
          // Try immediately
          setupBuyNowInterceptor();
          
          // Try again after delays
          [500, 1000, 2000, 3000, 5000].forEach(delay => {
            setTimeout(() => {
              console.log(` Retrying setupBuyNowInterceptor after ${delay}ms...`);
              setupBuyNowInterceptor();
            }, delay);
          });
          
          // Also set up periodic checks to ensure interceptor is working (reduced to 20% frequency)
          setInterval(() => {
            const productNode = document.getElementById('product-component-1764405426589');
            if (productNode) {
              const iframes = productNode.querySelectorAll('iframe');
              const buttons = productNode.querySelectorAll('button, a, [role="button"]');
              console.log(' Periodic check:', {
                productNode: !!productNode,
                iframes: iframes.length,
                buttons: buttons.length,
                viewer: !!window.viewer,
                stlFunction: typeof window.generateAndUploadSTL
              });
              
              // Log button details
              buttons.forEach((btn, i) => {
                console.log(` Button ${i + 1}:`, {
                  text: btn.textContent?.trim().substring(0, 50),
                  tagName: btn.tagName,
                  className: btn.className,
                  id: btn.id
                });
              });
            }
          }, 25000); // Reduced to 20% frequency (25 seconds instead of 5 seconds)
          
          // Log when viewer becomes available
          const checkViewerReady = setInterval(() => {
            if (window.viewer) {
              console.log(' Viewer is now available');
              console.log(' generateAndUploadSTL function:', typeof window.generateAndUploadSTL);
              clearInterval(checkViewerReady);
            }
          }, 500);
          
          // Clear interval after 30 seconds
          setTimeout(() => {
            clearInterval(checkViewerReady);
          }, 30000);
          
          // Hide Shopify cart toggle after component loads and continuously monitor
          function hideCartToggle() {
            // Hide cart toggle using various selectors
            const cartSelectors = [
              '[data-shopify-button-component]',
              '.shopify-buy__cart-toggle',
              '.shopify-buy__cart-toggle-wrapper',
              'button[data-shopify-cart-toggle]',
              '[id*="shopify-cart"]',
              '[class*="shopify-buy__cart-toggle"]',
              '[class*="shopify-buy-frame"][class*="cart"]',
              'iframe[name*="cart"]',
              'iframe[title*="cart" i]',
              '[data-shopify-cart]'
            ];
            
            cartSelectors.forEach(selector => {
              try {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                  el.style.display = 'none !important';
                  el.style.visibility = 'hidden !important';
                  el.style.opacity = '0 !important';
                  el.style.pointerEvents = 'none !important';
                  el.style.width = '0 !important';
                  el.style.height = '0 !important';
                  el.style.position = 'absolute !important';
                  el.style.left = '-9999px !important';
                });
              } catch(e) {
                // Ignore selector errors
              }
            });
            
            // Also check for iframes that might contain the cart
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(iframe => {
              try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                if (iframeDoc) {
                  const cartElements = iframeDoc.querySelectorAll('[class*="cart"], [id*="cart"], button[title*="cart" i]');
                  cartElements.forEach(el => {
                    if (el.textContent.toLowerCase().includes('cart') || 
                        el.getAttribute('title')?.toLowerCase().includes('cart') ||
                        el.getAttribute('aria-label')?.toLowerCase().includes('cart')) {
                      el.style.display = 'none';
                      el.style.visibility = 'hidden';
                    }
                  });
                }
              } catch(e) {
                // Cross-origin iframe, can't access
              }
            });
          }
          
          // Run immediately and then periodically
          setTimeout(hideCartToggle, 1000);
          setTimeout(hideCartToggle, 2000);
          setTimeout(hideCartToggle, 3000);
          
          // Also monitor continuously
          setInterval(hideCartToggle, 2000);
          
          // Monitor for Buy Now button clicks using document-level listener
          console.log(' Setting up document-level click listener...');
          
          // Use only click event to avoid multiple triggers (mousedown + click + mouseup = 3 triggers!)
          document.addEventListener('click', function(e) {
              const target = e.target;
              const buttonText = target.textContent?.trim().toLowerCase() || '';
              const ariaLabel = target.getAttribute('aria-label')?.toLowerCase() || '';
              const className = target.className?.toLowerCase() || '';
              const id = target.id?.toLowerCase() || '';
              
              // Check if click is within the Shopify product component
              const isInShopifyComponent = target.closest('#product-component-1764405426589') || 
                                           target.closest('.shopify-buy-frame') ||
                                           target.closest('[class*="shopify"]') ||
                                           target.closest('[id*="product-component"]');
              
              // Log ALL clicks in the product area for debugging
              if (isInShopifyComponent) {
                console.log(' [click] Click detected within Shopify component');
                console.log(' Target:', target);
                console.log(' Target tagName:', target.tagName);
                console.log(' Target id:', id);
                console.log(' Button text:', buttonText);
                console.log(' Aria label:', ariaLabel);
                console.log(' Class name:', className);
                console.log(' Target HTML:', target.outerHTML.substring(0, 200));
                
                // Check if this is a Buy Now button - be very permissive
                const isBuyButton = (
                  buttonText.includes('buy now') || 
                  buttonText === 'buy' ||
                  buttonText.includes('purchase') ||
                  ariaLabel.includes('buy now') ||
                  ariaLabel.includes('buy') ||
                  ariaLabel.includes('purchase') ||
                  className.includes('buy') ||
                  className.includes('purchase') ||
                  id.includes('buy') ||
                  target.closest('[class*="buy"]') ||
                  target.closest('[class*="purchase"]') ||
                  target.closest('button')?.textContent?.toLowerCase().includes('buy') ||
                  target.closest('a')?.textContent?.toLowerCase().includes('buy') ||
                  (target.tagName === 'BUTTON' && isInShopifyComponent) ||
                  (target.tagName === 'A' && isInShopifyComponent)
                );
                
                console.log(' Is Buy Button:', isBuyButton);
                
                if (isBuyButton || (isInShopifyComponent && (target.tagName === 'BUTTON' || target.tagName === 'A'))) {
                  console.log(` ===== Buy Now button detected (document-level click) =====`);
                  
                  // Check if we've already handled this click (prevent duplicate processing)
                  if (e.target.dataset.stlProcessed === 'true') {
                    console.log(' Buy button already processed, skipping duplicate');
                    return;
                  }
                  
                  // Mark as processed
                  e.target.dataset.stlProcessed = 'true';
                  
                  // Generate Order ID IMMEDIATELY before checkout opens (only if not already generated)
                  if (typeof window.generateStlOrderId === 'function' && !sessionStorage.getItem('stlOrderId')) {
                    const orderId = window.generateStlOrderId();
                    console.log(' Order ID generated and added to checkout:', orderId);
                  } else if (sessionStorage.getItem('stlOrderId')) {
                    console.log(' Order ID already exists:', sessionStorage.getItem('stlOrderId'));
                  }
                  
                  // Generate and upload STL in background - DO NOT BLOCK CHECKOUT
                  // Use setTimeout to ensure checkout opens immediately
                  if (window.viewer && window.generateAndUploadSTL) {
                    console.log(' Triggering STL generation in background (non-blocking)...');
                    // Fire and forget - don't await, don't block
                    setTimeout(() => {
                      window.generateAndUploadSTL().catch(err => {
                        console.error(' STL generation error (non-blocking):', err);
                      });
                    }, 0);
                  }
                  
                  // DO NOT prevent default - let Shopify handle checkout immediately
                  // DO NOT return false - allow normal flow
                }
              }
            }, true); // Use capture phase
          console.log(' Document-level click listener added');
          
          // URL monitoring removed - STL generation should only happen on Buy Now button click
          // Not on navigation, to prevent duplicate uploads
          
        }); // End of ShopifyBuy.UI.onReady().then()
      } // End of ShopifyBuyInit function
    })(); // End of IIFE
    /*]]>*/
    </script>

    <!-- Navigation Bar Script -->
    <script>
        // Shrink navbar on scroll
        let lastScrollTop = 0;
        const navbar = document.getElementById('navbar');
        
        window.addEventListener('scroll', function() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            if (scrollTop > 50) {
                navbar.classList.add('shrink');
            } else {
                navbar.classList.remove('shrink');
            }
            
            lastScrollTop = scrollTop;
        });
        
        // Smooth scroll to section
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                const navbarHeight = navbar.offsetHeight;
                const sectionPosition = section.getBoundingClientRect().top + window.pageYOffset - navbarHeight;
                
                window.scrollTo({
                    top: sectionPosition,
                    behavior: 'smooth'
                });
            }
        }
    </script>

<!-- Social Footer -->
<div class="social-footer">
    <div style="display: flex; justify-content: center; gap: 16px; flex-wrap: wrap;">
        <a href="https://facebook.com" target="_blank" rel="noopener noreferrer" aria-label="Facebook">
            <img src="/fblogo.png" alt="Facebook" style="height: 56px; width: 56px; object-fit: contain;">
        </a>
        <a href="https://instagram.com" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
            <img src="/iglogo.png" alt="Instagram" style="height: 56px; width: 56px; object-fit: contain;">
        </a>
        <a href="https://tiktok.com" target="_blank" rel="noopener noreferrer" aria-label="TikTok">
            <img src="/tiktoklogo.png" alt="TikTok" style="height: 56px; width: 56px; object-fit: contain;">
        </a>
    </div>
    <span style="width: 100%; text-align: center; color: var(--ink); font-size: 0.9em;">
         2026 Image Keepsake Studio. All rights reserved.
    </span>
</div>

</body>
</html>
<!-- Cache refresh: 2025-06-01 01:02 - S3 backend working --> 
<!-- Cache refresh: 2025-06-01 01:02 - S3 backend working --> 